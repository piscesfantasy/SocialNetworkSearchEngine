<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ver_20120624/Twitter/tweepy/cache.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>ver_20120624/Twitter/tweepy/cache.py</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment"># Tweepy</span>
<a name="l00002"></a>00002 <span class="comment"># Copyright 2009-2010 Joshua Roesslein</span>
<a name="l00003"></a>00003 <span class="comment"># See LICENSE for details.</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="keyword">import</span> time
<a name="l00006"></a>00006 <span class="keyword">import</span> threading
<a name="l00007"></a>00007 <span class="keyword">import</span> os
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="keywordflow">try</span>:
<a name="l00010"></a>00010     <span class="keyword">import</span> cPickle <span class="keyword">as</span> pickle
<a name="l00011"></a>00011 <span class="keywordflow">except</span> ImportError:
<a name="l00012"></a>00012     <span class="keyword">import</span> pickle
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="keywordflow">try</span>:
<a name="l00015"></a>00015     <span class="keyword">import</span> hashlib
<a name="l00016"></a>00016 <span class="keywordflow">except</span> ImportError:
<a name="l00017"></a>00017     <span class="comment"># python 2.4</span>
<a name="l00018"></a>00018     <span class="keyword">import</span> md5 <span class="keyword">as</span> hashlib
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="keywordflow">try</span>:
<a name="l00021"></a>00021     <span class="keyword">import</span> fcntl
<a name="l00022"></a>00022 <span class="keywordflow">except</span> ImportError:
<a name="l00023"></a>00023     <span class="comment"># Probably on a windows system</span>
<a name="l00024"></a>00024     <span class="comment"># TODO: use win32file</span>
<a name="l00025"></a>00025     <span class="keywordflow">pass</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 
<a name="l00028"></a><a class="code" href="classtweepy_1_1cache_1_1Cache.html">00028</a> <span class="keyword">class </span><a class="code" href="classtweepy_1_1cache_1_1Cache.html">Cache</a>(object):
<a name="l00029"></a>00029     <span class="stringliteral">&quot;&quot;&quot;Cache interface&quot;&quot;&quot;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a><a class="code" href="classtweepy_1_1cache_1_1Cache.html#ad99c23f002bb3122fa823d7e943d0774">00031</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1Cache.html#ad99c23f002bb3122fa823d7e943d0774">__init__</a>(self, timeout=60):
<a name="l00032"></a>00032         <span class="stringliteral">&quot;&quot;&quot;Initialize the cache</span>
<a name="l00033"></a>00033 <span class="stringliteral">            timeout: number of seconds to keep a cached entry</span>
<a name="l00034"></a>00034 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00035"></a>00035         self.<a class="code" href="classtweepy_1_1cache_1_1Cache.html#ac8894566f6bb63c4f74b732ce2127f8e">timeout</a> = timeout
<a name="l00036"></a>00036 
<a name="l00037"></a><a class="code" href="classtweepy_1_1cache_1_1Cache.html#a13d68ea991f68417e97c333c5e56e39d">00037</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1Cache.html#a13d68ea991f68417e97c333c5e56e39d">store</a>(self, key, value):
<a name="l00038"></a>00038         <span class="stringliteral">&quot;&quot;&quot;Add new record to cache</span>
<a name="l00039"></a>00039 <span class="stringliteral">            key: entry key</span>
<a name="l00040"></a>00040 <span class="stringliteral">            value: data of entry</span>
<a name="l00041"></a>00041 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00042"></a>00042         <span class="keywordflow">raise</span> NotImplementedError
<a name="l00043"></a>00043 
<a name="l00044"></a><a class="code" href="classtweepy_1_1cache_1_1Cache.html#a9a48e17952dd7ab11fe029b2ecfe12c8">00044</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1Cache.html#a9a48e17952dd7ab11fe029b2ecfe12c8">get</a>(self, key, timeout=None):
<a name="l00045"></a>00045         <span class="stringliteral">&quot;&quot;&quot;Get cached entry if exists and not expired</span>
<a name="l00046"></a>00046 <span class="stringliteral">            key: which entry to get</span>
<a name="l00047"></a>00047 <span class="stringliteral">            timeout: override timeout with this value [optional]</span>
<a name="l00048"></a>00048 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00049"></a>00049         <span class="keywordflow">raise</span> NotImplementedError
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="classtweepy_1_1cache_1_1Cache.html#a4c239f2e47b0fe4fdddb627aabac587d">00051</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1Cache.html#a4c239f2e47b0fe4fdddb627aabac587d">count</a>(self):
<a name="l00052"></a>00052         <span class="stringliteral">&quot;&quot;&quot;Get count of entries currently stored in cache&quot;&quot;&quot;</span>
<a name="l00053"></a>00053         <span class="keywordflow">raise</span> NotImplementedError
<a name="l00054"></a>00054 
<a name="l00055"></a><a class="code" href="classtweepy_1_1cache_1_1Cache.html#a66f5a11ca6f43ebc94a9fdc5f4b4628c">00055</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1Cache.html#a66f5a11ca6f43ebc94a9fdc5f4b4628c">cleanup</a>(self):
<a name="l00056"></a>00056         <span class="stringliteral">&quot;&quot;&quot;Delete any expired entries in cache.&quot;&quot;&quot;</span>
<a name="l00057"></a>00057         <span class="keywordflow">raise</span> NotImplementedError
<a name="l00058"></a>00058 
<a name="l00059"></a><a class="code" href="classtweepy_1_1cache_1_1Cache.html#a4929658646e53b9d2c979970157910dd">00059</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1Cache.html#a4929658646e53b9d2c979970157910dd">flush</a>(self):
<a name="l00060"></a>00060         <span class="stringliteral">&quot;&quot;&quot;Delete all cached entries&quot;&quot;&quot;</span>
<a name="l00061"></a>00061         <span class="keywordflow">raise</span> NotImplementedError
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 
<a name="l00064"></a><a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html">00064</a> <span class="keyword">class </span><a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html">MemoryCache</a>(<a class="code" href="classtweepy_1_1cache_1_1Cache.html">Cache</a>):
<a name="l00065"></a>00065     <span class="stringliteral">&quot;&quot;&quot;In-memory cache&quot;&quot;&quot;</span>
<a name="l00066"></a>00066 
<a name="l00067"></a><a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#ad4df9ba63b869bc22c9bbe6d83023174">00067</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#ad4df9ba63b869bc22c9bbe6d83023174">__init__</a>(self, timeout=60):
<a name="l00068"></a>00068         Cache.__init__(self, timeout)
<a name="l00069"></a>00069         self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#acc8715b333348594088b7adf226be31f">_entries</a> = {}
<a name="l00070"></a>00070         self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#aaaafd7a43c9ed54a02d044c02d347659">lock</a> = threading.Lock()
<a name="l00071"></a>00071 
<a name="l00072"></a>00072     <span class="keyword">def </span>__getstate__(self):
<a name="l00073"></a>00073         <span class="comment"># pickle</span>
<a name="l00074"></a>00074         <span class="keywordflow">return</span> {<span class="stringliteral">&#39;entries&#39;</span>: self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#acc8715b333348594088b7adf226be31f">_entries</a>, <span class="stringliteral">&#39;timeout&#39;</span>: self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#ad7f3844dcd05204c03ced3d8e7f99628">timeout</a>}
<a name="l00075"></a>00075 
<a name="l00076"></a>00076     <span class="keyword">def </span>__setstate__(self, state):
<a name="l00077"></a>00077         <span class="comment"># unpickle</span>
<a name="l00078"></a>00078         self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#aaaafd7a43c9ed54a02d044c02d347659">lock</a> = threading.Lock()
<a name="l00079"></a>00079         self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#acc8715b333348594088b7adf226be31f">_entries</a> = state[<span class="stringliteral">&#39;entries&#39;</span>]
<a name="l00080"></a>00080         self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#ad7f3844dcd05204c03ced3d8e7f99628">timeout</a> = state[<span class="stringliteral">&#39;timeout&#39;</span>]
<a name="l00081"></a>00081 
<a name="l00082"></a>00082     <span class="keyword">def </span>_is_expired(self, entry, timeout):
<a name="l00083"></a>00083         <span class="keywordflow">return</span> timeout &gt; 0 <span class="keywordflow">and</span> (time.time() - entry[0]) &gt;= timeout
<a name="l00084"></a>00084 
<a name="l00085"></a><a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#aa48040020bc92939ddaed79b3831d5ff">00085</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#aa48040020bc92939ddaed79b3831d5ff">store</a>(self, key, value):
<a name="l00086"></a>00086         self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#aaaafd7a43c9ed54a02d044c02d347659">lock</a>.acquire()
<a name="l00087"></a>00087         self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#acc8715b333348594088b7adf226be31f">_entries</a>[key] = (time.time(), value)
<a name="l00088"></a>00088         self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#aaaafd7a43c9ed54a02d044c02d347659">lock</a>.release()
<a name="l00089"></a>00089 
<a name="l00090"></a><a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#ac16075412258a10a9504118197fde180">00090</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#ac16075412258a10a9504118197fde180">get</a>(self, key, timeout=None):
<a name="l00091"></a>00091         self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#aaaafd7a43c9ed54a02d044c02d347659">lock</a>.acquire()
<a name="l00092"></a>00092         <span class="keywordflow">try</span>:
<a name="l00093"></a>00093             <span class="comment"># check to see if we have this key</span>
<a name="l00094"></a>00094             entry = self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#acc8715b333348594088b7adf226be31f">_entries</a>.get(key)
<a name="l00095"></a>00095             <span class="keywordflow">if</span> <span class="keywordflow">not</span> entry:
<a name="l00096"></a>00096                 <span class="comment"># no hit, return nothing</span>
<a name="l00097"></a>00097                 <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l00098"></a>00098 
<a name="l00099"></a>00099             <span class="comment"># use provided timeout in arguments if provided</span>
<a name="l00100"></a>00100             <span class="comment"># otherwise use the one provided during init.</span>
<a name="l00101"></a>00101             <span class="keywordflow">if</span> timeout <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00102"></a>00102                 timeout = self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#ad7f3844dcd05204c03ced3d8e7f99628">timeout</a>
<a name="l00103"></a>00103 
<a name="l00104"></a>00104             <span class="comment"># make sure entry is not expired</span>
<a name="l00105"></a>00105             <span class="keywordflow">if</span> self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#ab686a9ff305693ca8e26f973ddaca800">_is_expired</a>(entry, timeout):
<a name="l00106"></a>00106                 <span class="comment"># entry expired, delete and return nothing</span>
<a name="l00107"></a>00107                 del self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#acc8715b333348594088b7adf226be31f">_entries</a>[key]
<a name="l00108"></a>00108                 <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l00109"></a>00109 
<a name="l00110"></a>00110             <span class="comment"># entry found and not expired, return it</span>
<a name="l00111"></a>00111             <span class="keywordflow">return</span> entry[1]
<a name="l00112"></a>00112         <span class="keywordflow">finally</span>:
<a name="l00113"></a>00113             self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#aaaafd7a43c9ed54a02d044c02d347659">lock</a>.release()
<a name="l00114"></a>00114 
<a name="l00115"></a><a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#afd0828f7d212c357acec1d4d265f9d37">00115</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#afd0828f7d212c357acec1d4d265f9d37">count</a>(self):
<a name="l00116"></a>00116         <span class="keywordflow">return</span> len(self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#acc8715b333348594088b7adf226be31f">_entries</a>)
<a name="l00117"></a>00117 
<a name="l00118"></a><a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#ab7a461da26cea1a65c2864d84f992a1c">00118</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#ab7a461da26cea1a65c2864d84f992a1c">cleanup</a>(self):
<a name="l00119"></a>00119         self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#aaaafd7a43c9ed54a02d044c02d347659">lock</a>.acquire()
<a name="l00120"></a>00120         <span class="keywordflow">try</span>:
<a name="l00121"></a>00121             <span class="keywordflow">for</span> k, v <span class="keywordflow">in</span> self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#acc8715b333348594088b7adf226be31f">_entries</a>.items():
<a name="l00122"></a>00122                 <span class="keywordflow">if</span> self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#ab686a9ff305693ca8e26f973ddaca800">_is_expired</a>(v, self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#ad7f3844dcd05204c03ced3d8e7f99628">timeout</a>):
<a name="l00123"></a>00123                     del self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#acc8715b333348594088b7adf226be31f">_entries</a>[k]
<a name="l00124"></a>00124         <span class="keywordflow">finally</span>:
<a name="l00125"></a>00125             self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#aaaafd7a43c9ed54a02d044c02d347659">lock</a>.release()
<a name="l00126"></a>00126 
<a name="l00127"></a><a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#a984f2a608e1a31bf1ac8b16607d5b943">00127</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#a984f2a608e1a31bf1ac8b16607d5b943">flush</a>(self):
<a name="l00128"></a>00128         self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#aaaafd7a43c9ed54a02d044c02d347659">lock</a>.acquire()
<a name="l00129"></a>00129         self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#acc8715b333348594088b7adf226be31f">_entries</a>.clear()
<a name="l00130"></a>00130         self.<a class="code" href="classtweepy_1_1cache_1_1MemoryCache.html#aaaafd7a43c9ed54a02d044c02d347659">lock</a>.release()
<a name="l00131"></a>00131 
<a name="l00132"></a>00132 
<a name="l00133"></a><a class="code" href="classtweepy_1_1cache_1_1FileCache.html">00133</a> <span class="keyword">class </span><a class="code" href="classtweepy_1_1cache_1_1FileCache.html">FileCache</a>(<a class="code" href="classtweepy_1_1cache_1_1Cache.html">Cache</a>):
<a name="l00134"></a>00134     <span class="stringliteral">&quot;&quot;&quot;File-based cache&quot;&quot;&quot;</span>
<a name="l00135"></a>00135 
<a name="l00136"></a>00136     <span class="comment"># locks used to make cache thread-safe</span>
<a name="l00137"></a>00137     cache_locks = {}
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     <span class="keyword">def </span>__init__(self, cache_dir, timeout=60):
<a name="l00140"></a>00140         Cache.__init__(self, timeout)
<a name="l00141"></a>00141         <span class="keywordflow">if</span> os.path.exists(cache_dir) <span class="keywordflow">is</span> <span class="keyword">False</span>:
<a name="l00142"></a>00142             os.mkdir(cache_dir)
<a name="l00143"></a>00143         self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a3b0e4c5fe8de43e4f3efbbe34cc01e8a">cache_dir</a> = cache_dir
<a name="l00144"></a>00144         <span class="keywordflow">if</span> cache_dir <span class="keywordflow">in</span> FileCache.cache_locks:
<a name="l00145"></a>00145             self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a0046ae8d26987e6a77eb1b637694b308">lock</a> = FileCache.cache_locks[cache_dir]
<a name="l00146"></a>00146         <span class="keywordflow">else</span>:
<a name="l00147"></a>00147             self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a0046ae8d26987e6a77eb1b637694b308">lock</a> = threading.Lock()
<a name="l00148"></a>00148             FileCache.cache_locks[cache_dir] = self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a0046ae8d26987e6a77eb1b637694b308">lock</a>
<a name="l00149"></a>00149 
<a name="l00150"></a>00150         <span class="keywordflow">if</span> os.name == <span class="stringliteral">&#39;posix&#39;</span>:
<a name="l00151"></a>00151             self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a24f1f8f49ccdfd841eba28023010e4cd">_lock_file</a> = self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a4772294e6c848ac06af9b78302daaddc">_lock_file_posix</a>
<a name="l00152"></a>00152             self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#adab7634bd8da445eb2d81901000f835b">_unlock_file</a> = self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#aa2b875ac8e15216b723242585e3ae745">_unlock_file_posix</a>
<a name="l00153"></a>00153         <span class="keywordflow">elif</span> os.name == <span class="stringliteral">&#39;nt&#39;</span>:
<a name="l00154"></a>00154             self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a24f1f8f49ccdfd841eba28023010e4cd">_lock_file</a> = self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#aa98129edb1488851f1a207707c64259b">_lock_file_win32</a>
<a name="l00155"></a>00155             self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#adab7634bd8da445eb2d81901000f835b">_unlock_file</a> = self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a489c41d64d4bef40bc18bc76961a4d63">_unlock_file_win32</a>
<a name="l00156"></a>00156         <span class="keywordflow">else</span>:
<a name="l00157"></a>00157             <span class="keywordflow">print</span> <span class="stringliteral">&#39;Warning! FileCache locking not supported on this system!&#39;</span>
<a name="l00158"></a>00158             self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a24f1f8f49ccdfd841eba28023010e4cd">_lock_file</a> = self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#aee089d0b9daf928d53446bae982c1d6f">_lock_file_dummy</a>
<a name="l00159"></a>00159             self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#adab7634bd8da445eb2d81901000f835b">_unlock_file</a> = self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#ae790cee1b0b9af0be516b94155cb5082">_unlock_file_dummy</a>
<a name="l00160"></a>00160 
<a name="l00161"></a>00161     <span class="keyword">def </span>_get_path(self, key):
<a name="l00162"></a>00162         md5 = hashlib.md5()
<a name="l00163"></a>00163         md5.update(key)
<a name="l00164"></a>00164         <span class="keywordflow">return</span> os.path.join(self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a3b0e4c5fe8de43e4f3efbbe34cc01e8a">cache_dir</a>, md5.hexdigest())
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     <span class="keyword">def </span>_lock_file_dummy(self, path, exclusive=True):
<a name="l00167"></a>00167         <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l00168"></a>00168 
<a name="l00169"></a>00169     <span class="keyword">def </span>_unlock_file_dummy(self, lock):
<a name="l00170"></a>00170         <span class="keywordflow">return</span>
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <span class="keyword">def </span>_lock_file_posix(self, path, exclusive=True):
<a name="l00173"></a>00173         lock_path = path + <span class="stringliteral">&#39;.lock&#39;</span>
<a name="l00174"></a>00174         <span class="keywordflow">if</span> exclusive <span class="keywordflow">is</span> <span class="keyword">True</span>:
<a name="l00175"></a>00175             f_lock = open(lock_path, <span class="stringliteral">&#39;w&#39;</span>)
<a name="l00176"></a>00176             fcntl.lockf(f_lock, fcntl.LOCK_EX)
<a name="l00177"></a>00177         <span class="keywordflow">else</span>:
<a name="l00178"></a>00178             f_lock = open(lock_path, <span class="stringliteral">&#39;</span><span class="stringliteral">r&#39;)</span>
<a name="l00179"></a>00179 <span class="stringliteral">            fcntl.lockf(f_lock, fcntl.LOCK_SH)</span>
<a name="l00180"></a>00180 <span class="stringliteral">        </span><span class="keywordflow">if</span> os.path.exists(lock_path) <span class="keywordflow">is</span> <span class="keyword">False</span>:
<a name="l00181"></a>00181             f_lock.close()
<a name="l00182"></a>00182             <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l00183"></a>00183         <span class="keywordflow">return</span> f_lock
<a name="l00184"></a>00184 
<a name="l00185"></a>00185     <span class="keyword">def </span>_unlock_file_posix(self, lock):
<a name="l00186"></a>00186         lock.close()
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     <span class="keyword">def </span>_lock_file_win32(self, path, exclusive=True):
<a name="l00189"></a>00189         <span class="comment"># TODO: implement</span>
<a name="l00190"></a>00190         <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l00191"></a>00191 
<a name="l00192"></a>00192     <span class="keyword">def </span>_unlock_file_win32(self, lock):
<a name="l00193"></a>00193         <span class="comment"># TODO: implement</span>
<a name="l00194"></a>00194         <span class="keywordflow">return</span>
<a name="l00195"></a>00195 
<a name="l00196"></a>00196     <span class="keyword">def </span>_delete_file(self, path):
<a name="l00197"></a>00197         os.remove(path)
<a name="l00198"></a>00198         <span class="keywordflow">if</span> os.path.exists(path + <span class="stringliteral">&#39;.lock&#39;</span>):
<a name="l00199"></a>00199             os.remove(path + <span class="stringliteral">&#39;.lock&#39;</span>)
<a name="l00200"></a>00200 
<a name="l00201"></a><a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a64e68459286805e54977c473ebf034fe">00201</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a64e68459286805e54977c473ebf034fe">store</a>(self, key, value):
<a name="l00202"></a>00202         path = self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#ac104209f0d76a6a4e9f65f1199dff05d">_get_path</a>(key)
<a name="l00203"></a>00203         self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a0046ae8d26987e6a77eb1b637694b308">lock</a>.acquire()
<a name="l00204"></a>00204         <span class="keywordflow">try</span>:
<a name="l00205"></a>00205             <span class="comment"># acquire lock and open file</span>
<a name="l00206"></a>00206             f_lock = self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a24f1f8f49ccdfd841eba28023010e4cd">_lock_file</a>(path)
<a name="l00207"></a>00207             datafile = open(path, <span class="stringliteral">&#39;wb&#39;</span>)
<a name="l00208"></a>00208 
<a name="l00209"></a>00209             <span class="comment"># write data</span>
<a name="l00210"></a>00210             pickle.dump((time.time(), value), datafile)
<a name="l00211"></a>00211 
<a name="l00212"></a>00212             <span class="comment"># close and unlock file</span>
<a name="l00213"></a>00213             datafile.close()
<a name="l00214"></a>00214             self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#adab7634bd8da445eb2d81901000f835b">_unlock_file</a>(f_lock)
<a name="l00215"></a>00215         <span class="keywordflow">finally</span>:
<a name="l00216"></a>00216             self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a0046ae8d26987e6a77eb1b637694b308">lock</a>.release()
<a name="l00217"></a>00217 
<a name="l00218"></a><a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a406cfdaef7215208c25d443575caaba2">00218</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a406cfdaef7215208c25d443575caaba2">get</a>(self, key, timeout=None):
<a name="l00219"></a>00219         <span class="keywordflow">return</span> self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a7f95185baf02320718edb80d8fb774bd">_get</a>(self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#ac104209f0d76a6a4e9f65f1199dff05d">_get_path</a>(key), timeout)
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     <span class="keyword">def </span>_get(self, path, timeout):
<a name="l00222"></a>00222         <span class="keywordflow">if</span> os.path.exists(path) <span class="keywordflow">is</span> <span class="keyword">False</span>:
<a name="l00223"></a>00223             <span class="comment"># no record</span>
<a name="l00224"></a>00224             <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l00225"></a>00225         self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a0046ae8d26987e6a77eb1b637694b308">lock</a>.acquire()
<a name="l00226"></a>00226         <span class="keywordflow">try</span>:
<a name="l00227"></a>00227             <span class="comment"># acquire lock and open</span>
<a name="l00228"></a>00228             f_lock = self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a24f1f8f49ccdfd841eba28023010e4cd">_lock_file</a>(path, <span class="keyword">False</span>)
<a name="l00229"></a>00229             datafile = open(path, <span class="stringliteral">&#39;rb&#39;</span>)
<a name="l00230"></a>00230 
<a name="l00231"></a>00231             <span class="comment"># read pickled object</span>
<a name="l00232"></a>00232             created_time, value = pickle.load(datafile)
<a name="l00233"></a>00233             datafile.close()
<a name="l00234"></a>00234 
<a name="l00235"></a>00235             <span class="comment"># check if value is expired</span>
<a name="l00236"></a>00236             <span class="keywordflow">if</span> timeout <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00237"></a>00237                 timeout = self.timeout
<a name="l00238"></a>00238             <span class="keywordflow">if</span> timeout &gt; 0 <span class="keywordflow">and</span> (time.time() - created_time) &gt;= timeout:
<a name="l00239"></a>00239                 <span class="comment"># expired! delete from cache</span>
<a name="l00240"></a>00240                 value = <span class="keywordtype">None</span>
<a name="l00241"></a>00241                 self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#ae121366ef7fe6456510477b32cf2eb85">_delete_file</a>(path)
<a name="l00242"></a>00242 
<a name="l00243"></a>00243             <span class="comment"># unlock and return result</span>
<a name="l00244"></a>00244             self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#adab7634bd8da445eb2d81901000f835b">_unlock_file</a>(f_lock)
<a name="l00245"></a>00245             <span class="keywordflow">return</span> value
<a name="l00246"></a>00246         <span class="keywordflow">finally</span>:
<a name="l00247"></a>00247             self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a0046ae8d26987e6a77eb1b637694b308">lock</a>.release()
<a name="l00248"></a>00248 
<a name="l00249"></a><a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a3a77dac48fbb27ca6c43be5f8f1ec5e0">00249</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a3a77dac48fbb27ca6c43be5f8f1ec5e0">count</a>(self):
<a name="l00250"></a>00250         c = 0
<a name="l00251"></a>00251         <span class="keywordflow">for</span> entry <span class="keywordflow">in</span> os.listdir(self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a3b0e4c5fe8de43e4f3efbbe34cc01e8a">cache_dir</a>):
<a name="l00252"></a>00252             <span class="keywordflow">if</span> entry.endswith(<span class="stringliteral">&#39;.lock&#39;</span>):
<a name="l00253"></a>00253                 <span class="keywordflow">continue</span>
<a name="l00254"></a>00254             c += 1
<a name="l00255"></a>00255         <span class="keywordflow">return</span> c
<a name="l00256"></a>00256 
<a name="l00257"></a><a class="code" href="classtweepy_1_1cache_1_1FileCache.html#ac6ac155501a85f2f89393ad3a4688f79">00257</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1FileCache.html#ac6ac155501a85f2f89393ad3a4688f79">cleanup</a>(self):
<a name="l00258"></a>00258         <span class="keywordflow">for</span> entry <span class="keywordflow">in</span> os.listdir(self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a3b0e4c5fe8de43e4f3efbbe34cc01e8a">cache_dir</a>):
<a name="l00259"></a>00259             <span class="keywordflow">if</span> entry.endswith(<span class="stringliteral">&#39;.lock&#39;</span>):
<a name="l00260"></a>00260                 <span class="keywordflow">continue</span>
<a name="l00261"></a>00261             self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a7f95185baf02320718edb80d8fb774bd">_get</a>(os.path.join(self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a3b0e4c5fe8de43e4f3efbbe34cc01e8a">cache_dir</a>, entry), <span class="keywordtype">None</span>)
<a name="l00262"></a>00262 
<a name="l00263"></a><a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a1afe375d1192aec80297cea2e113da38">00263</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a1afe375d1192aec80297cea2e113da38">flush</a>(self):
<a name="l00264"></a>00264         <span class="keywordflow">for</span> entry <span class="keywordflow">in</span> os.listdir(self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a3b0e4c5fe8de43e4f3efbbe34cc01e8a">cache_dir</a>):
<a name="l00265"></a>00265             <span class="keywordflow">if</span> entry.endswith(<span class="stringliteral">&#39;.lock&#39;</span>):
<a name="l00266"></a>00266                 <span class="keywordflow">continue</span>
<a name="l00267"></a>00267             self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#ae121366ef7fe6456510477b32cf2eb85">_delete_file</a>(os.path.join(self.<a class="code" href="classtweepy_1_1cache_1_1FileCache.html#a3b0e4c5fe8de43e4f3efbbe34cc01e8a">cache_dir</a>, entry))
<a name="l00268"></a>00268 
<a name="l00269"></a><a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html">00269</a> <span class="keyword">class </span><a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html">MemCacheCache</a>(<a class="code" href="classtweepy_1_1cache_1_1Cache.html">Cache</a>):
<a name="l00270"></a>00270     <span class="stringliteral">&quot;&quot;&quot;Cache interface&quot;&quot;&quot;</span>
<a name="l00271"></a>00271 
<a name="l00272"></a><a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html#aa0914735f408f85eabc2955b36fba796">00272</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html#aa0914735f408f85eabc2955b36fba796">__init__</a>(self, client, timeout=60):
<a name="l00273"></a>00273         <span class="stringliteral">&quot;&quot;&quot;Initialize the cache</span>
<a name="l00274"></a>00274 <span class="stringliteral">            client: The memcache client</span>
<a name="l00275"></a>00275 <span class="stringliteral">            timeout: number of seconds to keep a cached entry</span>
<a name="l00276"></a>00276 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00277"></a>00277         self.<a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html#abb4365f98059f87b1db69868c7504763">client</a> = client
<a name="l00278"></a>00278         self.<a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html#ab7c6d6cf2b522845efc015101a505076">timeout</a> = timeout
<a name="l00279"></a>00279 
<a name="l00280"></a><a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html#a9f3dab60559dcc421241e4a1b07ea4d2">00280</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html#a9f3dab60559dcc421241e4a1b07ea4d2">store</a>(self, key, value):
<a name="l00281"></a>00281         <span class="stringliteral">&quot;&quot;&quot;Add new record to cache</span>
<a name="l00282"></a>00282 <span class="stringliteral">            key: entry key</span>
<a name="l00283"></a>00283 <span class="stringliteral">            value: data of entry</span>
<a name="l00284"></a>00284 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00285"></a>00285         self.<a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html#abb4365f98059f87b1db69868c7504763">client</a>.set(key, value, time=self.<a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html#ab7c6d6cf2b522845efc015101a505076">timeout</a>)
<a name="l00286"></a>00286 
<a name="l00287"></a><a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html#ae42926a2d3d1583fa45c45b7886f03d6">00287</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html#ae42926a2d3d1583fa45c45b7886f03d6">get</a>(self, key, timeout=None):
<a name="l00288"></a>00288         <span class="stringliteral">&quot;&quot;&quot;Get cached entry if exists and not expired</span>
<a name="l00289"></a>00289 <span class="stringliteral">            key: which entry to get</span>
<a name="l00290"></a>00290 <span class="stringliteral">            timeout: override timeout with this value [optional]. DOES NOT WORK HERE</span>
<a name="l00291"></a>00291 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00292"></a>00292         <span class="keywordflow">return</span> self.<a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html#abb4365f98059f87b1db69868c7504763">client</a>.get(key, key)
<a name="l00293"></a>00293 
<a name="l00294"></a><a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html#a221f34a523483a4f97c3aaf45d229ac2">00294</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html#a221f34a523483a4f97c3aaf45d229ac2">count</a>(self):
<a name="l00295"></a>00295         <span class="stringliteral">&quot;&quot;&quot;Get count of entries currently stored in cache. RETURN 0&quot;&quot;&quot;</span>
<a name="l00296"></a>00296         <span class="keywordflow">raise</span> NotImplementedError
<a name="l00297"></a>00297 
<a name="l00298"></a><a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html#a0bc87290e934b1a820ec12c7961b3547">00298</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html#a0bc87290e934b1a820ec12c7961b3547">cleanup</a>(self):
<a name="l00299"></a>00299         <span class="stringliteral">&quot;&quot;&quot;Delete any expired entries in cache. NO-OP&quot;&quot;&quot;</span>
<a name="l00300"></a>00300         <span class="keywordflow">raise</span> NotImplementedError
<a name="l00301"></a>00301 
<a name="l00302"></a><a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html#adc48e1e828dcd230943a6502832e6323">00302</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1MemCacheCache.html#adc48e1e828dcd230943a6502832e6323">flush</a>(self):
<a name="l00303"></a>00303         <span class="stringliteral">&quot;&quot;&quot;Delete all cached entries. NO-OP&quot;&quot;&quot;</span>
<a name="l00304"></a>00304         <span class="keywordflow">raise</span> NotImplementedError
<a name="l00305"></a>00305 
<a name="l00306"></a><a class="code" href="classtweepy_1_1cache_1_1RedisCache.html">00306</a> <span class="keyword">class </span><a class="code" href="classtweepy_1_1cache_1_1RedisCache.html">RedisCache</a>(<a class="code" href="classtweepy_1_1cache_1_1Cache.html">Cache</a>):
<a name="l00307"></a>00307     <span class="stringliteral">&#39;&#39;&#39;Cache running in a redis server&#39;&#39;&#39;</span>
<a name="l00308"></a>00308 
<a name="l00309"></a>00309     <span class="keyword">def </span>__init__(self, client, timeout=60, keys_container = &#39;tweepy:keys<span class="stringliteral">&#39;, pre_identifier = &#39;</span>tweepy:<span class="stringliteral">&#39;):</span>
<a name="l00310"></a>00310 <span class="stringliteral">        Cache.__init__(self, timeout)</span>
<a name="l00311"></a>00311 <span class="stringliteral">        self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a3df42c96a75886fe8f39f568dc289564">client</a> = client</span>
<a name="l00312"></a>00312 <span class="stringliteral">        self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#ab93d120219b7a01cd761a638f05e5e6a">keys_container</a> = keys_container</span>
<a name="l00313"></a>00313 <span class="stringliteral">        self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a248c2316f3f4f5d7d732b4b8dbc3192c">pre_identifier</a> = pre_identifier</span>
<a name="l00314"></a>00314 <span class="stringliteral"></span>
<a name="l00315"></a>00315 <span class="stringliteral">    </span><span class="keyword">def </span>_is_expired(self, entry, timeout):
<a name="l00316"></a>00316         <span class="comment"># Returns true if the entry has expired</span>
<a name="l00317"></a>00317         <span class="keywordflow">return</span> timeout &gt; 0 <span class="keywordflow">and</span> (time.time() - entry[0]) &gt;= timeout
<a name="l00318"></a>00318 
<a name="l00319"></a><a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a7bc402a3d5d6ac60b8565aa6482f4293">00319</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a7bc402a3d5d6ac60b8565aa6482f4293">store</a>(self, key, value):
<a name="l00320"></a>00320         <span class="stringliteral">&#39;&#39;&#39;Store the key, value pair in our redis server&#39;&#39;&#39;</span>
<a name="l00321"></a>00321         <span class="comment"># Prepend tweepy to our key, this makes it easier to identify tweepy keys in our redis server</span>
<a name="l00322"></a>00322         key = self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a248c2316f3f4f5d7d732b4b8dbc3192c">pre_identifier</a> + key
<a name="l00323"></a>00323         <span class="comment"># Get a pipe (to execute several redis commands in one step)</span>
<a name="l00324"></a>00324         pipe = self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a3df42c96a75886fe8f39f568dc289564">client</a>.pipeline()
<a name="l00325"></a>00325         <span class="comment"># Set our values in a redis hash (similar to python dict)</span>
<a name="l00326"></a>00326         pipe.set(key, pickle.dumps((time.time(), value)))
<a name="l00327"></a>00327         <span class="comment"># Set the expiration</span>
<a name="l00328"></a>00328         pipe.expire(key, self.timeout)
<a name="l00329"></a>00329         <span class="comment"># Add the key to a set containing all the keys</span>
<a name="l00330"></a>00330         pipe.sadd(self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#ab93d120219b7a01cd761a638f05e5e6a">keys_container</a>, key)
<a name="l00331"></a>00331         <span class="comment"># Execute the instructions in the redis server</span>
<a name="l00332"></a>00332         pipe.execute()
<a name="l00333"></a>00333 
<a name="l00334"></a><a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a394080c45a9ac59376036bdf77030572">00334</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a394080c45a9ac59376036bdf77030572">get</a>(self, key, timeout=None):
<a name="l00335"></a>00335         <span class="stringliteral">&#39;&#39;&#39;Given a key, returns an element from the redis table&#39;&#39;&#39;</span>
<a name="l00336"></a>00336         key = self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a248c2316f3f4f5d7d732b4b8dbc3192c">pre_identifier</a> + key
<a name="l00337"></a>00337         <span class="comment"># Check to see if we have this key</span>
<a name="l00338"></a>00338         unpickled_entry = self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a3df42c96a75886fe8f39f568dc289564">client</a>.get(key)
<a name="l00339"></a>00339         <span class="keywordflow">if</span> <span class="keywordflow">not</span> unpickled_entry:
<a name="l00340"></a>00340             <span class="comment"># No hit, return nothing</span>
<a name="l00341"></a>00341             <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l00342"></a>00342 
<a name="l00343"></a>00343         entry = pickle.loads(unpickled_entry)
<a name="l00344"></a>00344         <span class="comment"># Use provided timeout in arguments if provided</span>
<a name="l00345"></a>00345         <span class="comment"># otherwise use the one provided during init.</span>
<a name="l00346"></a>00346         <span class="keywordflow">if</span> timeout <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00347"></a>00347             timeout = self.timeout
<a name="l00348"></a>00348 
<a name="l00349"></a>00349         <span class="comment"># Make sure entry is not expired</span>
<a name="l00350"></a>00350         <span class="keywordflow">if</span> self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a5c31791bb80291953c9d948a5f18bcdd">_is_expired</a>(entry, timeout):
<a name="l00351"></a>00351             <span class="comment"># entry expired, delete and return nothing</span>
<a name="l00352"></a>00352             self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#ad66d57159a656e4ede844d4c4b5ee41f">delete_entry</a>(key)
<a name="l00353"></a>00353             <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l00354"></a>00354         <span class="comment"># entry found and not expired, return it</span>
<a name="l00355"></a>00355         <span class="keywordflow">return</span> entry[1]
<a name="l00356"></a>00356 
<a name="l00357"></a><a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#acd75744e40fa29c160938aafc475f0dc">00357</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#acd75744e40fa29c160938aafc475f0dc">count</a>(self):
<a name="l00358"></a>00358         <span class="stringliteral">&#39;&#39;&#39;Note: This is not very efficient, since it retreives all the keys from the redis</span>
<a name="l00359"></a>00359 <span class="stringliteral">        server to know how many keys we have&#39;&#39;&#39;</span>
<a name="l00360"></a>00360         <span class="keywordflow">return</span> len(self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a3df42c96a75886fe8f39f568dc289564">client</a>.smembers(self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#ab93d120219b7a01cd761a638f05e5e6a">keys_container</a>))
<a name="l00361"></a>00361 
<a name="l00362"></a><a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#ad66d57159a656e4ede844d4c4b5ee41f">00362</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#ad66d57159a656e4ede844d4c4b5ee41f">delete_entry</a>(self, key):
<a name="l00363"></a>00363         <span class="stringliteral">&#39;&#39;&#39;Delete an object from the redis table&#39;&#39;&#39;</span>
<a name="l00364"></a>00364         pipe = self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a3df42c96a75886fe8f39f568dc289564">client</a>.pipeline()
<a name="l00365"></a>00365         pipe.srem(self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#ab93d120219b7a01cd761a638f05e5e6a">keys_container</a>, key)
<a name="l00366"></a>00366         pipe.delete(key)
<a name="l00367"></a>00367         pipe.execute()
<a name="l00368"></a>00368 
<a name="l00369"></a><a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a1755bd3b43bd03f47c94a86c5c1e0d5c">00369</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a1755bd3b43bd03f47c94a86c5c1e0d5c">cleanup</a>(self):
<a name="l00370"></a>00370         <span class="stringliteral">&#39;&#39;&#39;Cleanup all the expired keys&#39;&#39;&#39;</span>
<a name="l00371"></a>00371         keys = self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a3df42c96a75886fe8f39f568dc289564">client</a>.smembers(self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#ab93d120219b7a01cd761a638f05e5e6a">keys_container</a>)
<a name="l00372"></a>00372         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> keys:
<a name="l00373"></a>00373             entry = self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a3df42c96a75886fe8f39f568dc289564">client</a>.get(key)
<a name="l00374"></a>00374             <span class="keywordflow">if</span> entry:
<a name="l00375"></a>00375                 entry = pickle.loads(entry)
<a name="l00376"></a>00376                 <span class="keywordflow">if</span> self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a5c31791bb80291953c9d948a5f18bcdd">_is_expired</a>(entry, self.timeout):
<a name="l00377"></a>00377                     self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#ad66d57159a656e4ede844d4c4b5ee41f">delete_entry</a>(key)
<a name="l00378"></a>00378 
<a name="l00379"></a><a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#ab2b137c58520a3c86b380ad89c08480b">00379</a>     <span class="keyword">def </span><a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#ab2b137c58520a3c86b380ad89c08480b">flush</a>(self):
<a name="l00380"></a>00380         <span class="stringliteral">&#39;&#39;&#39;Delete all entries from the cache&#39;&#39;&#39;</span>
<a name="l00381"></a>00381         keys = self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#a3df42c96a75886fe8f39f568dc289564">client</a>.smembers(self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#ab93d120219b7a01cd761a638f05e5e6a">keys_container</a>)
<a name="l00382"></a>00382         <span class="keywordflow">for</span> key <span class="keywordflow">in</span> keys:
<a name="l00383"></a>00383             self.<a class="code" href="classtweepy_1_1cache_1_1RedisCache.html#ad66d57159a656e4ede844d4c4b5ee41f">delete_entry</a>(key)
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Sun Jun 24 2012 20:50:11 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
