<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ver_20120624/Plurk/oauth2/__init__.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>ver_20120624/Plurk/oauth2/__init__.py</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespacePlurk_1_1oauth2.html">00001</a> <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00002"></a>00002 <span class="stringliteral">The MIT License</span>
<a name="l00003"></a>00003 <span class="stringliteral"></span>
<a name="l00004"></a>00004 <span class="stringliteral">Copyright (c) 2007-2010 Leah Culver, Joe Stump, Mark Paschal, Vic Fryzel</span>
<a name="l00005"></a>00005 <span class="stringliteral"></span>
<a name="l00006"></a>00006 <span class="stringliteral">Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<a name="l00007"></a>00007 <span class="stringliteral">of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<a name="l00008"></a>00008 <span class="stringliteral">in the Software without restriction, including without limitation the rights</span>
<a name="l00009"></a>00009 <span class="stringliteral">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<a name="l00010"></a>00010 <span class="stringliteral">copies of the Software, and to permit persons to whom the Software is</span>
<a name="l00011"></a>00011 <span class="stringliteral">furnished to do so, subject to the following conditions:</span>
<a name="l00012"></a>00012 <span class="stringliteral"></span>
<a name="l00013"></a>00013 <span class="stringliteral">The above copyright notice and this permission notice shall be included in</span>
<a name="l00014"></a>00014 <span class="stringliteral">all copies or substantial portions of the Software.</span>
<a name="l00015"></a>00015 <span class="stringliteral"></span>
<a name="l00016"></a>00016 <span class="stringliteral">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<a name="l00017"></a>00017 <span class="stringliteral">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<a name="l00018"></a>00018 <span class="stringliteral">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<a name="l00019"></a>00019 <span class="stringliteral">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<a name="l00020"></a>00020 <span class="stringliteral">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<a name="l00021"></a>00021 <span class="stringliteral">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</span>
<a name="l00022"></a>00022 <span class="stringliteral">THE SOFTWARE.</span>
<a name="l00023"></a>00023 <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="keyword">import</span> base64
<a name="l00026"></a>00026 <span class="keyword">import</span> urllib
<a name="l00027"></a>00027 <span class="keyword">import</span> time
<a name="l00028"></a>00028 <span class="keyword">import</span> random
<a name="l00029"></a>00029 <span class="keyword">import</span> urlparse
<a name="l00030"></a>00030 <span class="keyword">import</span> hmac
<a name="l00031"></a>00031 <span class="keyword">import</span> binascii
<a name="l00032"></a>00032 <span class="keyword">import</span> httplib2
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="keywordflow">try</span>:
<a name="l00035"></a>00035     <span class="keyword">from</span> urlparse <span class="keyword">import</span> parse_qs
<a name="l00036"></a>00036     parse_qs <span class="comment"># placate pyflakes</span>
<a name="l00037"></a>00037 <span class="keywordflow">except</span> ImportError:
<a name="l00038"></a>00038     <span class="comment"># fall back for Python 2.5</span>
<a name="l00039"></a>00039     <span class="keyword">from</span> cgi <span class="keyword">import</span> parse_qs
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="keywordflow">try</span>:
<a name="l00042"></a>00042     <span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1
<a name="l00043"></a>00043     sha = sha1
<a name="l00044"></a>00044 <span class="keywordflow">except</span> ImportError:
<a name="l00045"></a>00045     <span class="comment"># hashlib was added in Python 2.5</span>
<a name="l00046"></a>00046     <span class="keyword">import</span> sha
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="keyword">import</span> _version
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 __version__ = _version.__version__
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 OAUTH_VERSION = <span class="stringliteral">&#39;1.0&#39;</span>  <span class="comment"># Hi Blaine!</span>
<a name="l00053"></a>00053 HTTP_METHOD = <span class="stringliteral">&#39;GET&#39;</span>
<a name="l00054"></a>00054 SIGNATURE_METHOD = <span class="stringliteral">&#39;PLAINTEXT&#39;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 
<a name="l00057"></a><a class="code" href="classPlurk_1_1oauth2_1_1Error.html">00057</a> <span class="keyword">class </span><a class="code" href="classPlurk_1_1oauth2_1_1Error.html">Error</a>(RuntimeError):
<a name="l00058"></a>00058     <span class="stringliteral">&quot;&quot;&quot;Generic exception class.&quot;&quot;&quot;</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060     <span class="keyword">def </span>__init__(self, message=&#39;OAuth error occurred.&#39;):
<a name="l00061"></a>00061         self.<a class="code" href="classPlurk_1_1oauth2_1_1Error.html#ae5e6a6cb23cc21539b0f3d2afe88b08b">_message</a> = message
<a name="l00062"></a>00062 
<a name="l00063"></a>00063     @property
<a name="l00064"></a><a class="code" href="classPlurk_1_1oauth2_1_1Error.html#aec0415ed6fd86a5059d1afdce08b426f">00064</a>     <span class="keyword">def </span>message(self):
<a name="l00065"></a>00065         <span class="stringliteral">&quot;&quot;&quot;A hack to get around the deprecation errors in 2.6.&quot;&quot;&quot;</span>
<a name="l00066"></a>00066         <span class="keywordflow">return</span> self.<a class="code" href="classPlurk_1_1oauth2_1_1Error.html#ae5e6a6cb23cc21539b0f3d2afe88b08b">_message</a>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068     <span class="keyword">def </span>__str__(self):
<a name="l00069"></a>00069         <span class="keywordflow">return</span> self.<a class="code" href="classPlurk_1_1oauth2_1_1Error.html#ae5e6a6cb23cc21539b0f3d2afe88b08b">_message</a>
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 
<a name="l00072"></a><a class="code" href="classPlurk_1_1oauth2_1_1MissingSignature.html">00072</a> <span class="keyword">class </span><a class="code" href="classPlurk_1_1oauth2_1_1MissingSignature.html">MissingSignature</a>(<a class="code" href="classPlurk_1_1oauth2_1_1Error.html">Error</a>):
<a name="l00073"></a>00073     <span class="keywordflow">pass</span>
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 
<a name="l00076"></a><a class="code" href="namespacePlurk_1_1oauth2.html#ac1a5d9586a7629f2d9f2004961059799">00076</a> <span class="keyword">def </span><a class="code" href="namespacePlurk_1_1oauth2.html#ac1a5d9586a7629f2d9f2004961059799">build_authenticate_header</a>(realm=&#39;&#39;):
<a name="l00077"></a>00077     <span class="stringliteral">&quot;&quot;&quot;Optional WWW-Authenticate header (401 error)&quot;&quot;&quot;</span>
<a name="l00078"></a>00078     <span class="keywordflow">return</span> {<span class="stringliteral">&#39;WWW-Authenticate&#39;</span>: <span class="stringliteral">&#39;OAuth realm=&quot;%s&quot;&#39;</span> % realm}
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 
<a name="l00081"></a><a class="code" href="namespacePlurk_1_1oauth2.html#a94f11e6a193c45ce9386da3ae3a4ad4e">00081</a> <span class="keyword">def </span><a class="code" href="namespacePlurk_1_1oauth2.html#a94f11e6a193c45ce9386da3ae3a4ad4e">build_xoauth_string</a>(url, consumer, token=None):
<a name="l00082"></a>00082     <span class="stringliteral">&quot;&quot;&quot;Build an XOAUTH string for use in SMTP/IMPA authentication.&quot;&quot;&quot;</span>
<a name="l00083"></a>00083     request = Request.from_consumer_and_token(consumer, token,
<a name="l00084"></a>00084         <span class="stringliteral">&quot;GET&quot;</span>, url)
<a name="l00085"></a>00085 
<a name="l00086"></a>00086     signing_method = SignatureMethod_HMAC_SHA1()
<a name="l00087"></a>00087     request.sign_request(signing_method, consumer, token)
<a name="l00088"></a>00088 
<a name="l00089"></a>00089     params = []
<a name="l00090"></a>00090     <span class="keywordflow">for</span> k, v <span class="keywordflow">in</span> sorted(request.iteritems()):
<a name="l00091"></a>00091         <span class="keywordflow">if</span> v <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:
<a name="l00092"></a>00092             params.append(<span class="stringliteral">&#39;%s=&quot;%s&quot;&#39;</span> % (k, escape(v)))
<a name="l00093"></a>00093 
<a name="l00094"></a>00094     <span class="keywordflow">return</span> <span class="stringliteral">&quot;%s %s %s&quot;</span> % (<span class="stringliteral">&quot;GET&quot;</span>, url, <span class="stringliteral">&#39;,&#39;</span>.join(params))
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 
<a name="l00097"></a><a class="code" href="namespacePlurk_1_1oauth2.html#a8f84b5bb2bd314f6f202383fd2c65458">00097</a> <span class="keyword">def </span><a class="code" href="namespacePlurk_1_1oauth2.html#a8f84b5bb2bd314f6f202383fd2c65458">to_unicode</a>(s):
<a name="l00098"></a>00098     <span class="stringliteral">&quot;&quot;&quot; Convert to unicode, raise exception with instructive error</span>
<a name="l00099"></a>00099 <span class="stringliteral">    message if s is not unicode, ascii, or utf-8. &quot;&quot;&quot;</span>
<a name="l00100"></a>00100     <span class="keywordflow">if</span> <span class="keywordflow">not</span> isinstance(s, unicode):
<a name="l00101"></a>00101         <span class="keywordflow">if</span> <span class="keywordflow">not</span> isinstance(s, str):
<a name="l00102"></a>00102             <span class="keywordflow">raise</span> TypeError(<span class="stringliteral">&#39;You are required to pass either unicode or string here, not: %r (%s)&#39;</span> % (type(s), s))
<a name="l00103"></a>00103         <span class="keywordflow">try</span>:
<a name="l00104"></a>00104             s = s.decode(<span class="stringliteral">&#39;utf-8&#39;</span>)
<a name="l00105"></a>00105         <span class="keywordflow">except</span> UnicodeDecodeError, le:
<a name="l00106"></a>00106             <span class="keywordflow">raise</span> TypeError(<span class="stringliteral">&#39;You are required to pass either a unicode object or a utf-8 string here. You passed a Python string object which contained non-utf-8: %r. The UnicodeDecodeError that resulted from attempting to interpret it as utf-8 was: %s&#39;</span> % (s, le,))
<a name="l00107"></a>00107     <span class="keywordflow">return</span> s
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 <span class="keyword">def </span>to_utf8(s):
<a name="l00110"></a>00110     <span class="keywordflow">return</span> to_unicode(s).encode(<span class="stringliteral">&#39;utf-8&#39;</span>)
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 <span class="keyword">def </span>to_unicode_if_string(s):
<a name="l00113"></a>00113     <span class="keywordflow">if</span> isinstance(s, basestring):
<a name="l00114"></a>00114         <span class="keywordflow">return</span> to_unicode(s)
<a name="l00115"></a>00115     <span class="keywordflow">else</span>:
<a name="l00116"></a>00116         <span class="keywordflow">return</span> s
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 <span class="keyword">def </span>to_utf8_if_string(s):
<a name="l00119"></a>00119     <span class="keywordflow">if</span> isinstance(s, basestring):
<a name="l00120"></a>00120         <span class="keywordflow">return</span> to_utf8(s)
<a name="l00121"></a>00121     <span class="keywordflow">else</span>:
<a name="l00122"></a>00122         <span class="keywordflow">return</span> s
<a name="l00123"></a>00123 
<a name="l00124"></a><a class="code" href="namespacePlurk_1_1oauth2.html#a12293d4b34b9042cbc3a34ee8cbc219a">00124</a> <span class="keyword">def </span><a class="code" href="namespacePlurk_1_1oauth2.html#a12293d4b34b9042cbc3a34ee8cbc219a">to_unicode_optional_iterator</a>(x):
<a name="l00125"></a>00125     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00126"></a>00126 <span class="stringliteral">    Raise TypeError if x is a str containing non-utf8 bytes or if x is</span>
<a name="l00127"></a>00127 <span class="stringliteral">    an iterable which contains such a str.</span>
<a name="l00128"></a>00128 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00129"></a>00129     <span class="keywordflow">if</span> isinstance(x, basestring):
<a name="l00130"></a>00130         <span class="keywordflow">return</span> to_unicode(x)
<a name="l00131"></a>00131 
<a name="l00132"></a>00132     <span class="keywordflow">try</span>:
<a name="l00133"></a>00133         l = list(x)
<a name="l00134"></a>00134     <span class="keywordflow">except</span> TypeError, e:
<a name="l00135"></a>00135         <span class="keyword">assert</span> <span class="stringliteral">&#39;is not iterable&#39;</span> <span class="keywordflow">in</span> str(e)
<a name="l00136"></a>00136         <span class="keywordflow">return</span> x
<a name="l00137"></a>00137     <span class="keywordflow">else</span>:
<a name="l00138"></a>00138         <span class="keywordflow">return</span> [ to_unicode(e) <span class="keywordflow">for</span> e <span class="keywordflow">in</span> l ]
<a name="l00139"></a>00139 
<a name="l00140"></a><a class="code" href="namespacePlurk_1_1oauth2.html#ae46c726ce09c6f6f3982e66728a08b44">00140</a> <span class="keyword">def </span><a class="code" href="namespacePlurk_1_1oauth2.html#ae46c726ce09c6f6f3982e66728a08b44">to_utf8_optional_iterator</a>(x):
<a name="l00141"></a>00141     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00142"></a>00142 <span class="stringliteral">    Raise TypeError if x is a str or if x is an iterable which</span>
<a name="l00143"></a>00143 <span class="stringliteral">    contains a str.</span>
<a name="l00144"></a>00144 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00145"></a>00145     <span class="keywordflow">if</span> isinstance(x, basestring):
<a name="l00146"></a>00146         <span class="keywordflow">return</span> to_utf8(x)
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     <span class="keywordflow">try</span>:
<a name="l00149"></a>00149         l = list(x)
<a name="l00150"></a>00150     <span class="keywordflow">except</span> TypeError, e:
<a name="l00151"></a>00151         <span class="keyword">assert</span> <span class="stringliteral">&#39;is not iterable&#39;</span> <span class="keywordflow">in</span> str(e)
<a name="l00152"></a>00152         <span class="keywordflow">return</span> x
<a name="l00153"></a>00153     <span class="keywordflow">else</span>:
<a name="l00154"></a>00154         <span class="keywordflow">return</span> [ to_utf8_if_string(e) <span class="keywordflow">for</span> e <span class="keywordflow">in</span> l ]
<a name="l00155"></a>00155 
<a name="l00156"></a><a class="code" href="namespacePlurk_1_1oauth2.html#a1d205720a9bb6ec30f7b97140abaad1a">00156</a> <span class="keyword">def </span><a class="code" href="namespacePlurk_1_1oauth2.html#a1d205720a9bb6ec30f7b97140abaad1a">escape</a>(s):
<a name="l00157"></a>00157     <span class="stringliteral">&quot;&quot;&quot;Escape a URL including any /.&quot;&quot;&quot;</span>
<a name="l00158"></a>00158     <span class="keywordflow">return</span> urllib.quote(s.encode(<span class="stringliteral">&#39;utf-8&#39;</span>), safe=<span class="stringliteral">&#39;~&#39;</span>)
<a name="l00159"></a>00159 
<a name="l00160"></a><a class="code" href="namespacePlurk_1_1oauth2.html#a10c8e58aa8bba21d7cee795ca901a4e8">00160</a> <span class="keyword">def </span><a class="code" href="namespacePlurk_1_1oauth2.html#a10c8e58aa8bba21d7cee795ca901a4e8">generate_timestamp</a>():
<a name="l00161"></a>00161     <span class="stringliteral">&quot;&quot;&quot;Get seconds since epoch (UTC).&quot;&quot;&quot;</span>
<a name="l00162"></a>00162     <span class="keywordflow">return</span> int(time.time())
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 
<a name="l00165"></a><a class="code" href="namespacePlurk_1_1oauth2.html#a6fb36ea4d56b7f333581609718dcd31d">00165</a> <span class="keyword">def </span><a class="code" href="namespacePlurk_1_1oauth2.html#a6fb36ea4d56b7f333581609718dcd31d">generate_nonce</a>(length=8):
<a name="l00166"></a>00166     <span class="stringliteral">&quot;&quot;&quot;Generate pseudorandom number.&quot;&quot;&quot;</span>
<a name="l00167"></a>00167     <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>.join([str(random.randint(0, 9)) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(length)])
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 
<a name="l00170"></a><a class="code" href="namespacePlurk_1_1oauth2.html#a913a1c6e7536b9c4a7b9f85fdb53033b">00170</a> <span class="keyword">def </span><a class="code" href="namespacePlurk_1_1oauth2.html#a913a1c6e7536b9c4a7b9f85fdb53033b">generate_verifier</a>(length=8):
<a name="l00171"></a>00171     <span class="stringliteral">&quot;&quot;&quot;Generate pseudorandom number.&quot;&quot;&quot;</span>
<a name="l00172"></a>00172     <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>.join([str(random.randint(0, 9)) <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(length)])
<a name="l00173"></a>00173 
<a name="l00174"></a>00174 
<a name="l00175"></a><a class="code" href="classPlurk_1_1oauth2_1_1Consumer.html">00175</a> <span class="keyword">class </span><a class="code" href="classPlurk_1_1oauth2_1_1Consumer.html">Consumer</a>(object):
<a name="l00176"></a>00176     <span class="stringliteral">&quot;&quot;&quot;A consumer of OAuth-protected services.</span>
<a name="l00177"></a>00177 <span class="stringliteral"> </span>
<a name="l00178"></a>00178 <span class="stringliteral">    The OAuth consumer is a &quot;third-party&quot; service that wants to access</span>
<a name="l00179"></a>00179 <span class="stringliteral">    protected resources from an OAuth service provider on behalf of an end</span>
<a name="l00180"></a>00180 <span class="stringliteral">    user. It&#39;s kind of the OAuth client.</span>
<a name="l00181"></a>00181 <span class="stringliteral"> </span>
<a name="l00182"></a>00182 <span class="stringliteral">    Usually a consumer must be registered with the service provider by the</span>
<a name="l00183"></a>00183 <span class="stringliteral">    developer of the consumer software. As part of that process, the service</span>
<a name="l00184"></a>00184 <span class="stringliteral">    provider gives the consumer a *key* and a *secret* with which the consumer</span>
<a name="l00185"></a>00185 <span class="stringliteral">    software can identify itself to the service. The consumer will include its</span>
<a name="l00186"></a>00186 <span class="stringliteral">    key in each request to identify itself, but will use its secret only when</span>
<a name="l00187"></a>00187 <span class="stringliteral">    signing requests, to prove that the request is from that particular</span>
<a name="l00188"></a>00188 <span class="stringliteral">    registered consumer.</span>
<a name="l00189"></a>00189 <span class="stringliteral"> </span>
<a name="l00190"></a>00190 <span class="stringliteral">    Once registered, the consumer can then use its consumer credentials to ask</span>
<a name="l00191"></a>00191 <span class="stringliteral">    the service provider for a request token, kicking off the OAuth</span>
<a name="l00192"></a>00192 <span class="stringliteral">    authorization process.</span>
<a name="l00193"></a>00193 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     key = <span class="keywordtype">None</span>
<a name="l00196"></a>00196     secret = <span class="keywordtype">None</span>
<a name="l00197"></a>00197 
<a name="l00198"></a>00198     <span class="keyword">def </span>__init__(self, key, secret):
<a name="l00199"></a>00199         self.<a class="code" href="classPlurk_1_1oauth2_1_1Consumer.html#a21655b300a68e2f6cd2c55a61aacd32c">key</a> = key
<a name="l00200"></a>00200         self.<a class="code" href="classPlurk_1_1oauth2_1_1Consumer.html#a6f1d0efa2c3e43acbdea704ee6135681">secret</a> = secret
<a name="l00201"></a>00201 
<a name="l00202"></a>00202         <span class="keywordflow">if</span> self.<a class="code" href="classPlurk_1_1oauth2_1_1Consumer.html#a21655b300a68e2f6cd2c55a61aacd32c">key</a> <span class="keywordflow">is</span> <span class="keywordtype">None</span> <span class="keywordflow">or</span> self.<a class="code" href="classPlurk_1_1oauth2_1_1Consumer.html#a6f1d0efa2c3e43acbdea704ee6135681">secret</a> <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00203"></a>00203             <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&quot;Key and secret must be set.&quot;</span>)
<a name="l00204"></a>00204 
<a name="l00205"></a>00205     <span class="keyword">def </span>__str__(self):
<a name="l00206"></a>00206         data = {<span class="stringliteral">&#39;oauth_consumer_key&#39;</span>: self.<a class="code" href="classPlurk_1_1oauth2_1_1Consumer.html#a21655b300a68e2f6cd2c55a61aacd32c">key</a>,
<a name="l00207"></a>00207             <span class="stringliteral">&#39;oauth_consumer_secret&#39;</span>: self.<a class="code" href="classPlurk_1_1oauth2_1_1Consumer.html#a6f1d0efa2c3e43acbdea704ee6135681">secret</a>}
<a name="l00208"></a>00208 
<a name="l00209"></a>00209         <span class="keywordflow">return</span> urllib.urlencode(data)
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 
<a name="l00212"></a><a class="code" href="classPlurk_1_1oauth2_1_1Token.html">00212</a> <span class="keyword">class </span><a class="code" href="classPlurk_1_1oauth2_1_1Token.html">Token</a>(object):
<a name="l00213"></a>00213     <span class="stringliteral">&quot;&quot;&quot;An OAuth credential used to request authorization or a protected</span>
<a name="l00214"></a>00214 <span class="stringliteral">    resource.</span>
<a name="l00215"></a>00215 <span class="stringliteral"> </span>
<a name="l00216"></a>00216 <span class="stringliteral">    Tokens in OAuth comprise a *key* and a *secret*. The key is included in</span>
<a name="l00217"></a>00217 <span class="stringliteral">    requests to identify the token being used, but the secret is used only in</span>
<a name="l00218"></a>00218 <span class="stringliteral">    the signature, to prove that the requester is who the server gave the</span>
<a name="l00219"></a>00219 <span class="stringliteral">    token to.</span>
<a name="l00220"></a>00220 <span class="stringliteral"> </span>
<a name="l00221"></a>00221 <span class="stringliteral">    When first negotiating the authorization, the consumer asks for a *request</span>
<a name="l00222"></a>00222 <span class="stringliteral">    token* that the live user authorizes with the service provider. The</span>
<a name="l00223"></a>00223 <span class="stringliteral">    consumer then exchanges the request token for an *access token* that can</span>
<a name="l00224"></a>00224 <span class="stringliteral">    be used to access protected resources.</span>
<a name="l00225"></a>00225 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     key = <span class="keywordtype">None</span>
<a name="l00228"></a>00228     secret = <span class="keywordtype">None</span>
<a name="l00229"></a>00229     callback = <span class="keywordtype">None</span>
<a name="l00230"></a>00230     callback_confirmed = <span class="keywordtype">None</span>
<a name="l00231"></a>00231     verifier = <span class="keywordtype">None</span>
<a name="l00232"></a>00232 
<a name="l00233"></a>00233     <span class="keyword">def </span>__init__(self, key, secret):
<a name="l00234"></a>00234         self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#adb75ea3ab2fbe69e65f5cf0994ad200e">key</a> = key
<a name="l00235"></a>00235         self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#abf8c9140994c361c6ba04de0b918df76">secret</a> = secret
<a name="l00236"></a>00236 
<a name="l00237"></a>00237         <span class="keywordflow">if</span> self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#adb75ea3ab2fbe69e65f5cf0994ad200e">key</a> <span class="keywordflow">is</span> <span class="keywordtype">None</span> <span class="keywordflow">or</span> self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#abf8c9140994c361c6ba04de0b918df76">secret</a> <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00238"></a>00238             <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&quot;Key and secret must be set.&quot;</span>)
<a name="l00239"></a>00239 
<a name="l00240"></a>00240     <span class="keyword">def </span>set_callback(self, callback):
<a name="l00241"></a>00241         self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#ac75fd9ef52177b3fe5c5347c8ce41dd9">callback</a> = callback
<a name="l00242"></a>00242         self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#aa0bdbc9eb3a3c807360ba437e1b4050b">callback_confirmed</a> = <span class="stringliteral">&#39;true&#39;</span>
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     <span class="keyword">def </span>set_verifier(self, verifier=None):
<a name="l00245"></a>00245         <span class="keywordflow">if</span> verifier <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:
<a name="l00246"></a>00246             self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#a2d7dfa335b10015fb42d9c1dfe2df58f">verifier</a> = verifier
<a name="l00247"></a>00247         <span class="keywordflow">else</span>:
<a name="l00248"></a>00248             self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#a2d7dfa335b10015fb42d9c1dfe2df58f">verifier</a> = generate_verifier()
<a name="l00249"></a>00249 
<a name="l00250"></a>00250     <span class="keyword">def </span>get_callback_url(self):
<a name="l00251"></a>00251         <span class="keywordflow">if</span> self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#ac75fd9ef52177b3fe5c5347c8ce41dd9">callback</a> <span class="keywordflow">and</span> self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#a2d7dfa335b10015fb42d9c1dfe2df58f">verifier</a>:
<a name="l00252"></a>00252             <span class="comment"># Append the oauth_verifier.</span>
<a name="l00253"></a>00253             parts = urlparse.urlparse(self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#ac75fd9ef52177b3fe5c5347c8ce41dd9">callback</a>)
<a name="l00254"></a>00254             scheme, netloc, path, params, query, fragment = parts[:6]
<a name="l00255"></a>00255             <span class="keywordflow">if</span> query:
<a name="l00256"></a>00256                 query = <span class="stringliteral">&#39;%s&amp;oauth_verifier=%s&#39;</span> % (query, self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#a2d7dfa335b10015fb42d9c1dfe2df58f">verifier</a>)
<a name="l00257"></a>00257             <span class="keywordflow">else</span>:
<a name="l00258"></a>00258                 query = <span class="stringliteral">&#39;oauth_verifier=%s&#39;</span> % self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#a2d7dfa335b10015fb42d9c1dfe2df58f">verifier</a>
<a name="l00259"></a>00259             <span class="keywordflow">return</span> urlparse.urlunparse((scheme, netloc, path, params,
<a name="l00260"></a>00260                 query, fragment))
<a name="l00261"></a>00261         <span class="keywordflow">return</span> self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#ac75fd9ef52177b3fe5c5347c8ce41dd9">callback</a>
<a name="l00262"></a>00262 
<a name="l00263"></a><a class="code" href="classPlurk_1_1oauth2_1_1Token.html#a67a6836cac3429f7061512ef0de147dd">00263</a>     <span class="keyword">def </span>to_string(self):
<a name="l00264"></a>00264         <span class="stringliteral">&quot;&quot;&quot;Returns this token as a plain string, suitable for storage.</span>
<a name="l00265"></a>00265 <span class="stringliteral"> </span>
<a name="l00266"></a>00266 <span class="stringliteral">        The resulting string includes the token&#39;s secret, so you should never</span>
<a name="l00267"></a>00267 <span class="stringliteral">        send or store this string where a third party can read it.</span>
<a name="l00268"></a>00268 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00269"></a>00269 
<a name="l00270"></a>00270         data = {
<a name="l00271"></a>00271             <span class="stringliteral">&#39;oauth_token&#39;</span>: self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#adb75ea3ab2fbe69e65f5cf0994ad200e">key</a>,
<a name="l00272"></a>00272             <span class="stringliteral">&#39;oauth_token_secret&#39;</span>: self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#abf8c9140994c361c6ba04de0b918df76">secret</a>,
<a name="l00273"></a>00273         }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275         <span class="keywordflow">if</span> self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#aa0bdbc9eb3a3c807360ba437e1b4050b">callback_confirmed</a> <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:
<a name="l00276"></a>00276             data[<span class="stringliteral">&#39;oauth_callback_confirmed&#39;</span>] = self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#aa0bdbc9eb3a3c807360ba437e1b4050b">callback_confirmed</a>
<a name="l00277"></a>00277         <span class="keywordflow">return</span> urllib.urlencode(data)
<a name="l00278"></a>00278  
<a name="l00279"></a>00279     @staticmethod
<a name="l00280"></a><a class="code" href="classPlurk_1_1oauth2_1_1Token.html#a953ff244ac5174561d8c2ce20036497c">00280</a>     <span class="keyword">def </span>from_string(s):
<a name="l00281"></a>00281         <span class="stringliteral">&quot;&quot;&quot;Deserializes a token from a string like one returned by</span>
<a name="l00282"></a>00282 <span class="stringliteral">        `to_string()`.&quot;&quot;&quot;</span>
<a name="l00283"></a>00283 
<a name="l00284"></a>00284         <span class="keywordflow">if</span> <span class="keywordflow">not</span> len(s):
<a name="l00285"></a>00285             <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&quot;Invalid parameter string.&quot;</span>)
<a name="l00286"></a>00286 
<a name="l00287"></a>00287         params = parse_qs(s, keep_blank_values=<span class="keyword">False</span>)
<a name="l00288"></a>00288         <span class="keywordflow">if</span> <span class="keywordflow">not</span> len(params):
<a name="l00289"></a>00289             <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&quot;Invalid parameter string.&quot;</span>)
<a name="l00290"></a>00290 
<a name="l00291"></a>00291         <span class="keywordflow">try</span>:
<a name="l00292"></a>00292             key = params[<span class="stringliteral">&#39;oauth_token&#39;</span>][0]
<a name="l00293"></a>00293         <span class="keywordflow">except</span> Exception:
<a name="l00294"></a>00294             <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&quot;&#39;oauth_token&#39; not found in OAuth request.&quot;</span>)
<a name="l00295"></a>00295 
<a name="l00296"></a>00296         <span class="keywordflow">try</span>:
<a name="l00297"></a>00297             secret = params[<span class="stringliteral">&#39;oauth_token_secret&#39;</span>][0]
<a name="l00298"></a>00298         <span class="keywordflow">except</span> Exception:
<a name="l00299"></a>00299             <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&quot;&#39;oauth_token_secret&#39; not found in &quot;</span> 
<a name="l00300"></a>00300                 <span class="stringliteral">&quot;OAuth request.&quot;</span>)
<a name="l00301"></a>00301 
<a name="l00302"></a>00302         token = Token(key, secret)
<a name="l00303"></a>00303         <span class="keywordflow">try</span>:
<a name="l00304"></a>00304             token.callback_confirmed = params[<span class="stringliteral">&#39;oauth_callback_confirmed&#39;</span>][0]
<a name="l00305"></a>00305         <span class="keywordflow">except</span> KeyError:
<a name="l00306"></a>00306             <span class="keywordflow">pass</span>  <span class="comment"># 1.0, no callback confirmed.</span>
<a name="l00307"></a>00307         <span class="keywordflow">return</span> token
<a name="l00308"></a>00308 
<a name="l00309"></a>00309     <span class="keyword">def </span>__str__(self):
<a name="l00310"></a>00310         <span class="keywordflow">return</span> self.<a class="code" href="classPlurk_1_1oauth2_1_1Token.html#a67a6836cac3429f7061512ef0de147dd">to_string</a>()
<a name="l00311"></a>00311 
<a name="l00312"></a>00312 
<a name="l00313"></a>00313 <span class="keyword">def </span>setter(attr):
<a name="l00314"></a>00314     name = attr.__name__
<a name="l00315"></a>00315  
<a name="l00316"></a>00316     <span class="keyword">def </span>getter(self):
<a name="l00317"></a>00317         <span class="keywordflow">try</span>:
<a name="l00318"></a>00318             <span class="keywordflow">return</span> self.__dict__[name]
<a name="l00319"></a>00319         <span class="keywordflow">except</span> KeyError:
<a name="l00320"></a>00320             <span class="keywordflow">raise</span> AttributeError(name)
<a name="l00321"></a>00321  
<a name="l00322"></a>00322     <span class="keyword">def </span>deleter(self):
<a name="l00323"></a>00323         del self.__dict__[name]
<a name="l00324"></a>00324  
<a name="l00325"></a>00325     <span class="keywordflow">return</span> property(getter, attr, deleter)
<a name="l00326"></a>00326 
<a name="l00327"></a>00327 
<a name="l00328"></a><a class="code" href="classPlurk_1_1oauth2_1_1Request.html">00328</a> <span class="keyword">class </span><a class="code" href="classPlurk_1_1oauth2_1_1Request.html">Request</a>(dict):
<a name="l00329"></a>00329  
<a name="l00330"></a>00330     <span class="stringliteral">&quot;&quot;&quot;The parameters and information for an HTTP request, suitable for</span>
<a name="l00331"></a>00331 <span class="stringliteral">    authorizing with OAuth credentials.</span>
<a name="l00332"></a>00332 <span class="stringliteral"> </span>
<a name="l00333"></a>00333 <span class="stringliteral">    When a consumer wants to access a service&#39;s protected resources, it does</span>
<a name="l00334"></a>00334 <span class="stringliteral">    so using a signed HTTP request identifying itself (the consumer) with its</span>
<a name="l00335"></a>00335 <span class="stringliteral">    key, and providing an access token authorized by the end user to access</span>
<a name="l00336"></a>00336 <span class="stringliteral">    those resources.</span>
<a name="l00337"></a>00337 <span class="stringliteral"> </span>
<a name="l00338"></a>00338 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00339"></a>00339  
<a name="l00340"></a>00340     version = OAUTH_VERSION
<a name="l00341"></a>00341 
<a name="l00342"></a>00342     <span class="keyword">def </span>__init__(self, method=HTTP_METHOD, url=None, parameters=None,
<a name="l00343"></a>00343                  body=<span class="stringliteral">&#39;&#39;</span>, is_form_encoded=<span class="keyword">False</span>):
<a name="l00344"></a>00344         <span class="keywordflow">if</span> url <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:
<a name="l00345"></a>00345             self.<a class="code" href="classPlurk_1_1oauth2_1_1Request.html#afcf185fdc0d2d42fe22ce6f2d7eef6c0">url</a> = to_unicode(url)
<a name="l00346"></a>00346         self.<a class="code" href="classPlurk_1_1oauth2_1_1Request.html#a4d8ed44e2cc101598a917e5068cd3531">method</a> = method
<a name="l00347"></a>00347         <span class="keywordflow">if</span> parameters <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:
<a name="l00348"></a>00348             <span class="keywordflow">for</span> k, v <span class="keywordflow">in</span> parameters.iteritems():
<a name="l00349"></a>00349                 k = to_unicode(k)
<a name="l00350"></a>00350                 v = to_unicode_optional_iterator(v)
<a name="l00351"></a>00351                 self[k] = v
<a name="l00352"></a>00352         self.<a class="code" href="classPlurk_1_1oauth2_1_1Request.html#a99455f2d7dbd868ceec661569b54dacd">body</a> = body
<a name="l00353"></a>00353         self.<a class="code" href="classPlurk_1_1oauth2_1_1Request.html#a6183d4101397df953b3eeb883b79a5ee">is_form_encoded</a> = is_form_encoded
<a name="l00354"></a>00354 
<a name="l00355"></a>00355 
<a name="l00356"></a>00356     @setter
<a name="l00357"></a>00357     <span class="keyword">def </span>url(self, value):
<a name="l00358"></a>00358         self.__dict__[<span class="stringliteral">&#39;url&#39;</span>] = value
<a name="l00359"></a>00359         <span class="keywordflow">if</span> value <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:
<a name="l00360"></a>00360             scheme, netloc, path, params, query, fragment = urlparse.urlparse(value)
<a name="l00361"></a>00361 
<a name="l00362"></a>00362             <span class="comment"># Exclude default port numbers.</span>
<a name="l00363"></a>00363             <span class="keywordflow">if</span> scheme == <span class="stringliteral">&#39;http&#39;</span> <span class="keywordflow">and</span> netloc[-3:] == <span class="stringliteral">&#39;:80&#39;</span>:
<a name="l00364"></a>00364                 netloc = netloc[:-3]
<a name="l00365"></a>00365             <span class="keywordflow">elif</span> scheme == <span class="stringliteral">&#39;https&#39;</span> <span class="keywordflow">and</span> netloc[-4:] == <span class="stringliteral">&#39;:443&#39;</span>:
<a name="l00366"></a>00366                 netloc = netloc[:-4]
<a name="l00367"></a>00367             <span class="keywordflow">if</span> scheme <span class="keywordflow">not</span> <span class="keywordflow">in</span> (<span class="stringliteral">&#39;http&#39;</span>, <span class="stringliteral">&#39;https&#39;</span>):
<a name="l00368"></a>00368                 <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&quot;Unsupported URL %s (%s).&quot;</span> % (value, scheme))
<a name="l00369"></a>00369 
<a name="l00370"></a>00370             <span class="comment"># Normalized URL excludes params, query, and fragment.</span>
<a name="l00371"></a>00371             self.<a class="code" href="classPlurk_1_1oauth2_1_1Request.html#a815fcc58688c6a873f76c96addaed9bc">normalized_url</a> = urlparse.urlunparse((scheme, netloc, path, <span class="keywordtype">None</span>, <span class="keywordtype">None</span>, <span class="keywordtype">None</span>))
<a name="l00372"></a>00372         <span class="keywordflow">else</span>:
<a name="l00373"></a>00373             self.<a class="code" href="classPlurk_1_1oauth2_1_1Request.html#a815fcc58688c6a873f76c96addaed9bc">normalized_url</a> = <span class="keywordtype">None</span>
<a name="l00374"></a>00374             self.__dict__[<span class="stringliteral">&#39;url&#39;</span>] = <span class="keywordtype">None</span>
<a name="l00375"></a>00375  
<a name="l00376"></a>00376     @setter
<a name="l00377"></a>00377     <span class="keyword">def </span>method(self, value):
<a name="l00378"></a>00378         self.__dict__[<span class="stringliteral">&#39;method&#39;</span>] = value.upper()
<a name="l00379"></a>00379  
<a name="l00380"></a>00380     <span class="keyword">def </span>_get_timestamp_nonce(self):
<a name="l00381"></a>00381         <span class="keywordflow">return</span> self[<span class="stringliteral">&#39;oauth_timestamp&#39;</span>], self[<span class="stringliteral">&#39;oauth_nonce&#39;</span>]
<a name="l00382"></a>00382  
<a name="l00383"></a><a class="code" href="classPlurk_1_1oauth2_1_1Request.html#a0530575ffbc7d0e7c4d36932a1426b29">00383</a>     <span class="keyword">def </span>get_nonoauth_parameters(self):
<a name="l00384"></a>00384         <span class="stringliteral">&quot;&quot;&quot;Get any non-OAuth parameters.&quot;&quot;&quot;</span>
<a name="l00385"></a>00385         <span class="keywordflow">return</span> dict([(k, v) <span class="keywordflow">for</span> k, v <span class="keywordflow">in</span> self.iteritems() 
<a name="l00386"></a>00386                     <span class="keywordflow">if</span> <span class="keywordflow">not</span> k.startswith(<span class="stringliteral">&#39;oauth_&#39;</span>)])
<a name="l00387"></a>00387  
<a name="l00388"></a><a class="code" href="classPlurk_1_1oauth2_1_1Request.html#a43ec11e83065fd3d3322f1dd2a712e06">00388</a>     <span class="keyword">def </span>to_header(self, realm=&#39;&#39;):
<a name="l00389"></a>00389         <span class="stringliteral">&quot;&quot;&quot;Serialize as a header for an HTTPAuth request.&quot;&quot;&quot;</span>
<a name="l00390"></a>00390         oauth_params = ((k, v) <span class="keywordflow">for</span> k, v <span class="keywordflow">in</span> self.items() 
<a name="l00391"></a>00391                             <span class="keywordflow">if</span> k.startswith(<span class="stringliteral">&#39;oauth_&#39;</span>))
<a name="l00392"></a>00392         stringy_params = ((k, escape(str(v))) <span class="keywordflow">for</span> k, v <span class="keywordflow">in</span> oauth_params)
<a name="l00393"></a>00393         header_params = (<span class="stringliteral">&#39;%s=&quot;%s&quot;&#39;</span> % (k, v) <span class="keywordflow">for</span> k, v <span class="keywordflow">in</span> stringy_params)
<a name="l00394"></a>00394         params_header = <span class="stringliteral">&#39;, &#39;</span>.join(header_params)
<a name="l00395"></a>00395  
<a name="l00396"></a>00396         auth_header = <span class="stringliteral">&#39;OAuth realm=&quot;%s&quot;&#39;</span> % realm
<a name="l00397"></a>00397         <span class="keywordflow">if</span> params_header:
<a name="l00398"></a>00398             auth_header = <span class="stringliteral">&quot;%s, %s&quot;</span> % (auth_header, params_header)
<a name="l00399"></a>00399  
<a name="l00400"></a>00400         <span class="keywordflow">return</span> {<span class="stringliteral">&#39;Authorization&#39;</span>: auth_header}
<a name="l00401"></a>00401  
<a name="l00402"></a><a class="code" href="classPlurk_1_1oauth2_1_1Request.html#ac02eaf6b54b189ec3696c7c4fb973ef4">00402</a>     <span class="keyword">def </span>to_postdata(self):
<a name="l00403"></a>00403         <span class="stringliteral">&quot;&quot;&quot;Serialize as post data for a POST request.&quot;&quot;&quot;</span>
<a name="l00404"></a>00404         d = {}
<a name="l00405"></a>00405         <span class="keywordflow">for</span> k, v <span class="keywordflow">in</span> self.iteritems():
<a name="l00406"></a>00406             d[k.encode(<span class="stringliteral">&#39;utf-8&#39;</span>)] = to_utf8_optional_iterator(v)
<a name="l00407"></a>00407 
<a name="l00408"></a>00408         <span class="comment"># tell urlencode to deal with sequence values and map them correctly</span>
<a name="l00409"></a>00409         <span class="comment"># to resulting querystring. for example self[&quot;k&quot;] = [&quot;v1&quot;, &quot;v2&quot;] will</span>
<a name="l00410"></a>00410         <span class="comment"># result in &#39;k=v1&amp;k=v2&#39; and not k=%5B%27v1%27%2C+%27v2%27%5D</span>
<a name="l00411"></a>00411         <span class="keywordflow">return</span> urllib.urlencode(d, <span class="keyword">True</span>).replace(<span class="stringliteral">&#39;+&#39;</span>, <span class="stringliteral">&#39;%20&#39;</span>)
<a name="l00412"></a>00412  
<a name="l00413"></a><a class="code" href="classPlurk_1_1oauth2_1_1Request.html#acebbb790f9c46bda9de14af45c44278e">00413</a>     <span class="keyword">def </span>to_url(self):
<a name="l00414"></a>00414         <span class="stringliteral">&quot;&quot;&quot;Serialize as a URL for a GET request.&quot;&quot;&quot;</span>
<a name="l00415"></a>00415         base_url = urlparse.urlparse(self.<a class="code" href="classPlurk_1_1oauth2_1_1Request.html#afcf185fdc0d2d42fe22ce6f2d7eef6c0">url</a>)
<a name="l00416"></a>00416         <span class="keywordflow">try</span>:
<a name="l00417"></a>00417             query = base_url.query
<a name="l00418"></a>00418         <span class="keywordflow">except</span> AttributeError:
<a name="l00419"></a>00419             <span class="comment"># must be python &lt;2.5</span>
<a name="l00420"></a>00420             query = base_url[4]
<a name="l00421"></a>00421         query = parse_qs(query)
<a name="l00422"></a>00422         <span class="keywordflow">for</span> k, v <span class="keywordflow">in</span> self.items():
<a name="l00423"></a>00423             query.setdefault(k, []).append(v)
<a name="l00424"></a>00424         
<a name="l00425"></a>00425         <span class="keywordflow">try</span>:
<a name="l00426"></a>00426             scheme = base_url.scheme
<a name="l00427"></a>00427             netloc = base_url.netloc
<a name="l00428"></a>00428             path = base_url.path
<a name="l00429"></a>00429             params = base_url.params
<a name="l00430"></a>00430             fragment = base_url.fragment
<a name="l00431"></a>00431         <span class="keywordflow">except</span> AttributeError:
<a name="l00432"></a>00432             <span class="comment"># must be python &lt;2.5</span>
<a name="l00433"></a>00433             scheme = base_url[0]
<a name="l00434"></a>00434             netloc = base_url[1]
<a name="l00435"></a>00435             path = base_url[2]
<a name="l00436"></a>00436             params = base_url[3]
<a name="l00437"></a>00437             fragment = base_url[5]
<a name="l00438"></a>00438         
<a name="l00439"></a>00439         url = (scheme, netloc, path, params,
<a name="l00440"></a>00440                urllib.urlencode(query, <span class="keyword">True</span>), fragment)
<a name="l00441"></a>00441         <span class="keywordflow">return</span> urlparse.urlunparse(url)
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     <span class="keyword">def </span>get_parameter(self, parameter):
<a name="l00444"></a>00444         ret = self.get(parameter)
<a name="l00445"></a>00445         <span class="keywordflow">if</span> ret <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00446"></a>00446             <span class="keywordflow">raise</span> Error(<span class="stringliteral">&#39;Parameter not found: %s&#39;</span> % parameter)
<a name="l00447"></a>00447 
<a name="l00448"></a>00448         <span class="keywordflow">return</span> ret
<a name="l00449"></a>00449 
<a name="l00450"></a><a class="code" href="classPlurk_1_1oauth2_1_1Request.html#aebcf05d381198fdcf7ed54f0e219eca7">00450</a>     <span class="keyword">def </span>get_normalized_parameters(self):
<a name="l00451"></a>00451         <span class="stringliteral">&quot;&quot;&quot;Return a string that contains the parameters that must be signed.&quot;&quot;&quot;</span>
<a name="l00452"></a>00452         items = []
<a name="l00453"></a>00453         <span class="keywordflow">for</span> key, value <span class="keywordflow">in</span> self.iteritems():
<a name="l00454"></a>00454             <span class="keywordflow">if</span> key == <span class="stringliteral">&#39;oauth_signature&#39;</span>:
<a name="l00455"></a>00455                 <span class="keywordflow">continue</span>
<a name="l00456"></a>00456             <span class="comment"># 1.0a/9.1.1 states that kvp must be sorted by key, then by value,</span>
<a name="l00457"></a>00457             <span class="comment"># so we unpack sequence values into multiple items for sorting.</span>
<a name="l00458"></a>00458             <span class="keywordflow">if</span> isinstance(value, basestring):
<a name="l00459"></a>00459                 items.append((to_utf8_if_string(key), to_utf8(value)))
<a name="l00460"></a>00460             <span class="keywordflow">else</span>:
<a name="l00461"></a>00461                 <span class="keywordflow">try</span>:
<a name="l00462"></a>00462                     value = list(value)
<a name="l00463"></a>00463                 <span class="keywordflow">except</span> TypeError, e:
<a name="l00464"></a>00464                     <span class="keyword">assert</span> <span class="stringliteral">&#39;is not iterable&#39;</span> <span class="keywordflow">in</span> str(e)
<a name="l00465"></a>00465                     items.append((to_utf8_if_string(key), to_utf8_if_string(value)))
<a name="l00466"></a>00466                 <span class="keywordflow">else</span>:
<a name="l00467"></a>00467                     items.extend((to_utf8_if_string(key), to_utf8_if_string(item)) <span class="keywordflow">for</span> item <span class="keywordflow">in</span> value)
<a name="l00468"></a>00468 
<a name="l00469"></a>00469         <span class="comment"># Include any query string parameters from the provided URL</span>
<a name="l00470"></a>00470         query = urlparse.urlparse(self.<a class="code" href="classPlurk_1_1oauth2_1_1Request.html#afcf185fdc0d2d42fe22ce6f2d7eef6c0">url</a>)[4]
<a name="l00471"></a>00471 
<a name="l00472"></a>00472         url_items = self.<a class="code" href="classPlurk_1_1oauth2_1_1Request.html#a98c19209cf89934cf937cfffbbb87635">_split_url_string</a>(query).items()
<a name="l00473"></a>00473         url_items = [(to_utf8(k), to_utf8(v)) <span class="keywordflow">for</span> k, v <span class="keywordflow">in</span> url_items <span class="keywordflow">if</span> k != <span class="stringliteral">&#39;oauth_signature&#39;</span> ]
<a name="l00474"></a>00474         items.extend(url_items)
<a name="l00475"></a>00475 
<a name="l00476"></a>00476         items.sort()
<a name="l00477"></a>00477         encoded_str = urllib.urlencode(items)
<a name="l00478"></a>00478         <span class="comment"># Encode signature parameters per Oauth Core 1.0 protocol</span>
<a name="l00479"></a>00479         <span class="comment"># spec draft 7, section 3.6</span>
<a name="l00480"></a>00480         <span class="comment"># (http://tools.ietf.org/html/draft-hammer-oauth-07#section-3.6)</span>
<a name="l00481"></a>00481         <span class="comment"># Spaces must be encoded with &quot;%20&quot; instead of &quot;+&quot;</span>
<a name="l00482"></a>00482         <span class="keywordflow">return</span> encoded_str.replace(<span class="stringliteral">&#39;+&#39;</span>, <span class="stringliteral">&#39;%20&#39;</span>).replace(<span class="stringliteral">&#39;%7E&#39;</span>, <span class="stringliteral">&#39;~&#39;</span>)
<a name="l00483"></a>00483 
<a name="l00484"></a><a class="code" href="classPlurk_1_1oauth2_1_1Request.html#af40bb4db9f34bb1953246aefdb417096">00484</a>     <span class="keyword">def </span>sign_request(self, signature_method, consumer, token):
<a name="l00485"></a>00485         <span class="stringliteral">&quot;&quot;&quot;Set the signature parameter to the result of sign.&quot;&quot;&quot;</span>
<a name="l00486"></a>00486 
<a name="l00487"></a>00487         <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.<a class="code" href="classPlurk_1_1oauth2_1_1Request.html#a6183d4101397df953b3eeb883b79a5ee">is_form_encoded</a>:
<a name="l00488"></a>00488             <span class="comment"># according to</span>
<a name="l00489"></a>00489             <span class="comment"># http://oauth.googlecode.com/svn/spec/ext/body_hash/1.0/oauth-bodyhash.html</span>
<a name="l00490"></a>00490             <span class="comment"># section 4.1.1 &quot;OAuth Consumers MUST NOT include an</span>
<a name="l00491"></a>00491             <span class="comment"># oauth_body_hash parameter on requests with form-encoded</span>
<a name="l00492"></a>00492             <span class="comment"># request bodies.&quot;</span>
<a name="l00493"></a>00493             self[<span class="stringliteral">&#39;oauth_body_hash&#39;</span>] = base64.b64encode(sha(self.<a class="code" href="classPlurk_1_1oauth2_1_1Request.html#a99455f2d7dbd868ceec661569b54dacd">body</a>).digest())
<a name="l00494"></a>00494 
<a name="l00495"></a>00495         <span class="keywordflow">if</span> <span class="stringliteral">&#39;oauth_consumer_key&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self:
<a name="l00496"></a>00496             self[<span class="stringliteral">&#39;oauth_consumer_key&#39;</span>] = consumer.key
<a name="l00497"></a>00497 
<a name="l00498"></a>00498         <span class="keywordflow">if</span> token <span class="keywordflow">and</span> <span class="stringliteral">&#39;oauth_token&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> self:
<a name="l00499"></a>00499             self[<span class="stringliteral">&#39;oauth_token&#39;</span>] = token.key
<a name="l00500"></a>00500 
<a name="l00501"></a>00501         self[<span class="stringliteral">&#39;oauth_signature_method&#39;</span>] = signature_method.name
<a name="l00502"></a>00502         self[<span class="stringliteral">&#39;oauth_signature&#39;</span>] = signature_method.sign(self, consumer, token)
<a name="l00503"></a>00503  
<a name="l00504"></a>00504     @classmethod
<a name="l00505"></a><a class="code" href="classPlurk_1_1oauth2_1_1Request.html#a46da62c40686463341a65075550ad455">00505</a>     <span class="keyword">def </span>make_timestamp(cls):
<a name="l00506"></a>00506         <span class="stringliteral">&quot;&quot;&quot;Get seconds since epoch (UTC).&quot;&quot;&quot;</span>
<a name="l00507"></a>00507         <span class="keywordflow">return</span> str(int(time.time()))
<a name="l00508"></a>00508  
<a name="l00509"></a>00509     @classmethod
<a name="l00510"></a><a class="code" href="classPlurk_1_1oauth2_1_1Request.html#a3d71962d096c300b41245b1cbdd76c53">00510</a>     <span class="keyword">def </span>make_nonce(cls):
<a name="l00511"></a>00511         <span class="stringliteral">&quot;&quot;&quot;Generate pseudorandom number.&quot;&quot;&quot;</span>
<a name="l00512"></a>00512         <span class="keywordflow">return</span> str(random.randint(0, 100000000))
<a name="l00513"></a>00513  
<a name="l00514"></a>00514     @classmethod
<a name="l00515"></a><a class="code" href="classPlurk_1_1oauth2_1_1Request.html#a69c2a46bbe1284ccc3e0c5671aa6836b">00515</a>     <span class="keyword">def </span>from_request(cls, http_method, http_url, headers=None, parameters=None,
<a name="l00516"></a>00516             query_string=<span class="keywordtype">None</span>):
<a name="l00517"></a>00517         <span class="stringliteral">&quot;&quot;&quot;Combines multiple parameter sources.&quot;&quot;&quot;</span>
<a name="l00518"></a>00518         <span class="keywordflow">if</span> parameters <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00519"></a>00519             parameters = {}
<a name="l00520"></a>00520  
<a name="l00521"></a>00521         <span class="comment"># Headers</span>
<a name="l00522"></a>00522         <span class="keywordflow">if</span> headers <span class="keywordflow">and</span> <span class="stringliteral">&#39;Authorization&#39;</span> <span class="keywordflow">in</span> headers:
<a name="l00523"></a>00523             auth_header = headers[<span class="stringliteral">&#39;Authorization&#39;</span>]
<a name="l00524"></a>00524             <span class="comment"># Check that the authorization header is OAuth.</span>
<a name="l00525"></a>00525             <span class="keywordflow">if</span> auth_header[:6] == <span class="stringliteral">&#39;OAuth &#39;</span>:
<a name="l00526"></a>00526                 auth_header = auth_header[6:]
<a name="l00527"></a>00527                 <span class="keywordflow">try</span>:
<a name="l00528"></a>00528                     <span class="comment"># Get the parameters from the header.</span>
<a name="l00529"></a>00529                     header_params = cls._split_header(auth_header)
<a name="l00530"></a>00530                     parameters.update(header_params)
<a name="l00531"></a>00531                 <span class="keywordflow">except</span>:
<a name="l00532"></a>00532                     <span class="keywordflow">raise</span> Error(<span class="stringliteral">&#39;Unable to parse OAuth parameters from &#39;</span>
<a name="l00533"></a>00533                         <span class="stringliteral">&#39;Authorization header.&#39;</span>)
<a name="l00534"></a>00534  
<a name="l00535"></a>00535         <span class="comment"># GET or POST query string.</span>
<a name="l00536"></a>00536         <span class="keywordflow">if</span> query_string:
<a name="l00537"></a>00537             query_params = cls._split_url_string(query_string)
<a name="l00538"></a>00538             parameters.update(query_params)
<a name="l00539"></a>00539  
<a name="l00540"></a>00540         <span class="comment"># URL parameters.</span>
<a name="l00541"></a>00541         param_str = urlparse.urlparse(http_url)[4] <span class="comment"># query</span>
<a name="l00542"></a>00542         url_params = cls._split_url_string(param_str)
<a name="l00543"></a>00543         parameters.update(url_params)
<a name="l00544"></a>00544  
<a name="l00545"></a>00545         <span class="keywordflow">if</span> parameters:
<a name="l00546"></a>00546             <span class="keywordflow">return</span> cls(http_method, http_url, parameters)
<a name="l00547"></a>00547  
<a name="l00548"></a>00548         <span class="keywordflow">return</span> <span class="keywordtype">None</span>
<a name="l00549"></a>00549  
<a name="l00550"></a>00550     @classmethod
<a name="l00551"></a>00551     <span class="keyword">def </span>from_consumer_and_token(cls, consumer, token=None,
<a name="l00552"></a>00552             http_method=HTTP_METHOD, http_url=<span class="keywordtype">None</span>, parameters=<span class="keywordtype">None</span>,
<a name="l00553"></a>00553             body=<span class="stringliteral">&#39;&#39;</span>, is_form_encoded=<span class="keyword">False</span>):
<a name="l00554"></a>00554         <span class="keywordflow">if</span> <span class="keywordflow">not</span> parameters:
<a name="l00555"></a>00555             parameters = {}
<a name="l00556"></a>00556  
<a name="l00557"></a>00557         defaults = {
<a name="l00558"></a>00558             <span class="stringliteral">&#39;oauth_consumer_key&#39;</span>: consumer.key,
<a name="l00559"></a>00559             <span class="stringliteral">&#39;oauth_timestamp&#39;</span>: cls.make_timestamp(),
<a name="l00560"></a>00560             <span class="stringliteral">&#39;oauth_nonce&#39;</span>: cls.make_nonce(),
<a name="l00561"></a>00561             <span class="stringliteral">&#39;oauth_version&#39;</span>: cls.version,
<a name="l00562"></a>00562         }
<a name="l00563"></a>00563  
<a name="l00564"></a>00564         defaults.update(parameters)
<a name="l00565"></a>00565         parameters = defaults
<a name="l00566"></a>00566  
<a name="l00567"></a>00567         <span class="keywordflow">if</span> token:
<a name="l00568"></a>00568             parameters[<span class="stringliteral">&#39;oauth_token&#39;</span>] = token.key
<a name="l00569"></a>00569             <span class="keywordflow">if</span> token.verifier:
<a name="l00570"></a>00570                 parameters[<span class="stringliteral">&#39;oauth_verifier&#39;</span>] = token.verifier
<a name="l00571"></a>00571  
<a name="l00572"></a>00572         <span class="keywordflow">return</span> Request(http_method, http_url, parameters, body=body, 
<a name="l00573"></a>00573                        is_form_encoded=is_form_encoded)
<a name="l00574"></a>00574  
<a name="l00575"></a>00575     @classmethod
<a name="l00576"></a>00576     <span class="keyword">def </span>from_token_and_callback(cls, token, callback=None, 
<a name="l00577"></a>00577         http_method=HTTP_METHOD, http_url=<span class="keywordtype">None</span>, parameters=<span class="keywordtype">None</span>):
<a name="l00578"></a>00578 
<a name="l00579"></a>00579         <span class="keywordflow">if</span> <span class="keywordflow">not</span> parameters:
<a name="l00580"></a>00580             parameters = {}
<a name="l00581"></a>00581  
<a name="l00582"></a>00582         parameters[<span class="stringliteral">&#39;oauth_token&#39;</span>] = token.key
<a name="l00583"></a>00583  
<a name="l00584"></a>00584         <span class="keywordflow">if</span> callback:
<a name="l00585"></a>00585             parameters[<span class="stringliteral">&#39;oauth_callback&#39;</span>] = callback
<a name="l00586"></a>00586  
<a name="l00587"></a>00587         <span class="keywordflow">return</span> cls(http_method, http_url, parameters)
<a name="l00588"></a>00588  
<a name="l00589"></a>00589     @staticmethod
<a name="l00590"></a>00590     <span class="keyword">def </span>_split_header(header):
<a name="l00591"></a>00591         <span class="stringliteral">&quot;&quot;&quot;Turn Authorization: header into parameters.&quot;&quot;&quot;</span>
<a name="l00592"></a>00592         params = {}
<a name="l00593"></a>00593         parts = header.split(<span class="stringliteral">&#39;,&#39;</span>)
<a name="l00594"></a>00594         <span class="keywordflow">for</span> param <span class="keywordflow">in</span> parts:
<a name="l00595"></a>00595             <span class="comment"># Ignore realm parameter.</span>
<a name="l00596"></a>00596             <span class="keywordflow">if</span> param.find(<span class="stringliteral">&#39;realm&#39;</span>) &gt; -1:
<a name="l00597"></a>00597                 <span class="keywordflow">continue</span>
<a name="l00598"></a>00598             <span class="comment"># Remove whitespace.</span>
<a name="l00599"></a>00599             param = param.strip()
<a name="l00600"></a>00600             <span class="comment"># Split key-value.</span>
<a name="l00601"></a>00601             param_parts = param.split(<span class="stringliteral">&#39;=&#39;</span>, 1)
<a name="l00602"></a>00602             <span class="comment"># Remove quotes and unescape the value.</span>
<a name="l00603"></a>00603             params[param_parts[0]] = urllib.unquote(param_parts[1].strip(<span class="stringliteral">&#39;\&quot;&#39;</span>))
<a name="l00604"></a>00604         <span class="keywordflow">return</span> params
<a name="l00605"></a>00605  
<a name="l00606"></a>00606     @staticmethod
<a name="l00607"></a>00607     <span class="keyword">def </span>_split_url_string(param_str):
<a name="l00608"></a>00608         <span class="stringliteral">&quot;&quot;&quot;Turn URL string into parameters.&quot;&quot;&quot;</span>
<a name="l00609"></a>00609         parameters = parse_qs(param_str.encode(<span class="stringliteral">&#39;utf-8&#39;</span>), keep_blank_values=<span class="keyword">True</span>)
<a name="l00610"></a>00610         <span class="keywordflow">for</span> k, v <span class="keywordflow">in</span> parameters.iteritems():
<a name="l00611"></a>00611             parameters[k] = urllib.unquote(v[0])
<a name="l00612"></a>00612         <span class="keywordflow">return</span> parameters
<a name="l00613"></a>00613 
<a name="l00614"></a>00614 
<a name="l00615"></a><a class="code" href="classPlurk_1_1oauth2_1_1Client.html">00615</a> <span class="keyword">class </span><a class="code" href="classPlurk_1_1oauth2_1_1Client.html">Client</a>(httplib2.Http):
<a name="l00616"></a>00616     <span class="stringliteral">&quot;&quot;&quot;OAuthClient is a worker to attempt to execute a request.&quot;&quot;&quot;</span>
<a name="l00617"></a>00617 
<a name="l00618"></a><a class="code" href="classPlurk_1_1oauth2_1_1Client.html#a0fd402b9010cc9bd573b0fbeac5bdada">00618</a>     <span class="keyword">def </span>__init__(self, consumer, token=None, cache=None, timeout=None,
<a name="l00619"></a>00619         proxy_info=<span class="keywordtype">None</span>):
<a name="l00620"></a>00620 
<a name="l00621"></a>00621         <span class="keywordflow">if</span> consumer <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span> <span class="keywordflow">and</span> <span class="keywordflow">not</span> isinstance(consumer, Consumer):
<a name="l00622"></a>00622             <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&quot;Invalid consumer.&quot;</span>)
<a name="l00623"></a>00623 
<a name="l00624"></a>00624         <span class="keywordflow">if</span> token <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span> <span class="keywordflow">and</span> <span class="keywordflow">not</span> isinstance(token, Token):
<a name="l00625"></a>00625             <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&quot;Invalid token.&quot;</span>)
<a name="l00626"></a>00626 
<a name="l00627"></a>00627         self.<a class="code" href="classPlurk_1_1oauth2_1_1Client.html#a2417c8168a8abdb0bb903de418f181c5">consumer</a> = consumer
<a name="l00628"></a>00628         self.<a class="code" href="classPlurk_1_1oauth2_1_1Client.html#aafe73a9d68b24415e644c2ceaa5637d0">token</a> = token
<a name="l00629"></a>00629         self.<a class="code" href="classPlurk_1_1oauth2_1_1Client.html#ade763ed78211fa728df1d2ed8b227240">method</a> = SignatureMethod_HMAC_SHA1()
<a name="l00630"></a>00630 
<a name="l00631"></a>00631         httplib2.Http.__init__(self, cache=cache, timeout=timeout, proxy_info=proxy_info)
<a name="l00632"></a>00632 
<a name="l00633"></a>00633     <span class="keyword">def </span>set_signature_method(self, method):
<a name="l00634"></a>00634         <span class="keywordflow">if</span> <span class="keywordflow">not</span> isinstance(method, SignatureMethod):
<a name="l00635"></a>00635             <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&quot;Invalid signature method.&quot;</span>)
<a name="l00636"></a>00636 
<a name="l00637"></a>00637         self.<a class="code" href="classPlurk_1_1oauth2_1_1Client.html#ade763ed78211fa728df1d2ed8b227240">method</a> = method
<a name="l00638"></a>00638 
<a name="l00639"></a><a class="code" href="classPlurk_1_1oauth2_1_1Client.html#a9a8024517f452119c5fb318c5b5a1a51">00639</a>     <span class="keyword">def </span>request(self, uri, method=&quot;GET&quot;, body=&#39;&#39;, headers=None, 
<a name="l00640"></a>00640         redirections=httplib2.DEFAULT_MAX_REDIRECTS, connection_type=<span class="keywordtype">None</span>):
<a name="l00641"></a>00641         DEFAULT_POST_CONTENT_TYPE = <span class="stringliteral">&#39;application/x-www-form-urlencoded&#39;</span>
<a name="l00642"></a>00642 
<a name="l00643"></a>00643         <span class="keywordflow">if</span> <span class="keywordflow">not</span> isinstance(headers, dict):
<a name="l00644"></a>00644             headers = {}
<a name="l00645"></a>00645 
<a name="l00646"></a>00646         <span class="keywordflow">if</span> method == <span class="stringliteral">&quot;POST&quot;</span>:
<a name="l00647"></a>00647             headers[<span class="stringliteral">&#39;Content-Type&#39;</span>] = headers.get(<span class="stringliteral">&#39;Content-Type&#39;</span>, 
<a name="l00648"></a>00648                 DEFAULT_POST_CONTENT_TYPE)
<a name="l00649"></a>00649 
<a name="l00650"></a>00650         is_form_encoded = \
<a name="l00651"></a>00651             headers.get(<span class="stringliteral">&#39;Content-Type&#39;</span>) == <span class="stringliteral">&#39;application/x-www-form-urlencoded&#39;</span>
<a name="l00652"></a>00652 
<a name="l00653"></a>00653         <span class="keywordflow">if</span> is_form_encoded <span class="keywordflow">and</span> body:
<a name="l00654"></a>00654             parameters = parse_qs(body)
<a name="l00655"></a>00655         <span class="keywordflow">else</span>:
<a name="l00656"></a>00656             parameters = <span class="keywordtype">None</span>
<a name="l00657"></a>00657 
<a name="l00658"></a>00658         req = Request.from_consumer_and_token(self.<a class="code" href="classPlurk_1_1oauth2_1_1Client.html#a2417c8168a8abdb0bb903de418f181c5">consumer</a>, 
<a name="l00659"></a>00659             token=self.<a class="code" href="classPlurk_1_1oauth2_1_1Client.html#aafe73a9d68b24415e644c2ceaa5637d0">token</a>, http_method=method, http_url=uri, 
<a name="l00660"></a>00660             parameters=parameters, body=body, is_form_encoded=is_form_encoded)
<a name="l00661"></a>00661 
<a name="l00662"></a>00662         req.sign_request(self.<a class="code" href="classPlurk_1_1oauth2_1_1Client.html#ade763ed78211fa728df1d2ed8b227240">method</a>, self.<a class="code" href="classPlurk_1_1oauth2_1_1Client.html#a2417c8168a8abdb0bb903de418f181c5">consumer</a>, self.<a class="code" href="classPlurk_1_1oauth2_1_1Client.html#aafe73a9d68b24415e644c2ceaa5637d0">token</a>)
<a name="l00663"></a>00663 
<a name="l00664"></a>00664         schema, rest = urllib.splittype(uri)
<a name="l00665"></a>00665         <span class="keywordflow">if</span> rest.startswith(<span class="stringliteral">&#39;//&#39;</span>):
<a name="l00666"></a>00666             hierpart = <span class="stringliteral">&#39;//&#39;</span>
<a name="l00667"></a>00667         <span class="keywordflow">else</span>:
<a name="l00668"></a>00668             hierpart = <span class="stringliteral">&#39;&#39;</span>
<a name="l00669"></a>00669         host, rest = urllib.splithost(rest)
<a name="l00670"></a>00670 
<a name="l00671"></a>00671         realm = schema + <span class="stringliteral">&#39;:&#39;</span> + hierpart + host
<a name="l00672"></a>00672 
<a name="l00673"></a>00673         <span class="keywordflow">if</span> is_form_encoded:
<a name="l00674"></a>00674             body = req.to_postdata()
<a name="l00675"></a>00675         <span class="keywordflow">elif</span> method == <span class="stringliteral">&quot;GET&quot;</span>:
<a name="l00676"></a>00676             uri = req.to_url()
<a name="l00677"></a>00677         <span class="keywordflow">else</span>:
<a name="l00678"></a>00678             headers.update(req.to_header(realm=realm))
<a name="l00679"></a>00679 
<a name="l00680"></a>00680         <span class="keywordflow">return</span> httplib2.Http.request(self, uri, method=method, body=body,
<a name="l00681"></a>00681             headers=headers, redirections=redirections,
<a name="l00682"></a>00682             connection_type=connection_type)
<a name="l00683"></a>00683 
<a name="l00684"></a>00684 
<a name="l00685"></a><a class="code" href="classPlurk_1_1oauth2_1_1Server.html">00685</a> <span class="keyword">class </span><a class="code" href="classPlurk_1_1oauth2_1_1Server.html">Server</a>(object):
<a name="l00686"></a>00686     <span class="stringliteral">&quot;&quot;&quot;A skeletal implementation of a service provider, providing protected</span>
<a name="l00687"></a>00687 <span class="stringliteral">    resources to requests from authorized consumers.</span>
<a name="l00688"></a>00688 <span class="stringliteral"> </span>
<a name="l00689"></a>00689 <span class="stringliteral">    This class implements the logic to check requests for authorization. You</span>
<a name="l00690"></a>00690 <span class="stringliteral">    can use it with your web server or web framework to protect certain</span>
<a name="l00691"></a>00691 <span class="stringliteral">    resources with OAuth.</span>
<a name="l00692"></a>00692 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00693"></a>00693 
<a name="l00694"></a>00694     timestamp_threshold = 300 <span class="comment"># In seconds, five minutes.</span>
<a name="l00695"></a>00695     version = OAUTH_VERSION
<a name="l00696"></a>00696     signature_methods = <span class="keywordtype">None</span>
<a name="l00697"></a>00697 
<a name="l00698"></a>00698     <span class="keyword">def </span>__init__(self, signature_methods=None):
<a name="l00699"></a>00699         self.<a class="code" href="classPlurk_1_1oauth2_1_1Server.html#ab9bee8597bcbbb173b312d922298019f">signature_methods</a> = signature_methods <span class="keywordflow">or</span> {}
<a name="l00700"></a>00700 
<a name="l00701"></a>00701     <span class="keyword">def </span>add_signature_method(self, signature_method):
<a name="l00702"></a>00702         self.<a class="code" href="classPlurk_1_1oauth2_1_1Server.html#ab9bee8597bcbbb173b312d922298019f">signature_methods</a>[signature_method.name] = signature_method
<a name="l00703"></a>00703         <span class="keywordflow">return</span> self.<a class="code" href="classPlurk_1_1oauth2_1_1Server.html#ab9bee8597bcbbb173b312d922298019f">signature_methods</a>
<a name="l00704"></a>00704 
<a name="l00705"></a><a class="code" href="classPlurk_1_1oauth2_1_1Server.html#ab9b869654e4e88e0854494e84465f0b8">00705</a>     <span class="keyword">def </span>verify_request(self, request, consumer, token):
<a name="l00706"></a>00706         <span class="stringliteral">&quot;&quot;&quot;Verifies an api call and checks all the parameters.&quot;&quot;&quot;</span>
<a name="l00707"></a>00707 
<a name="l00708"></a>00708         self.<a class="code" href="classPlurk_1_1oauth2_1_1Server.html#addad5838c6816940faa8dad2ab77b1b1">_check_version</a>(request)
<a name="l00709"></a>00709         self.<a class="code" href="classPlurk_1_1oauth2_1_1Server.html#a093cb4692644f37876bf3d7420bd5846">_check_signature</a>(request, consumer, token)
<a name="l00710"></a>00710         parameters = request.get_nonoauth_parameters()
<a name="l00711"></a>00711         <span class="keywordflow">return</span> parameters
<a name="l00712"></a>00712 
<a name="l00713"></a><a class="code" href="classPlurk_1_1oauth2_1_1Server.html#a0630a4e7ba97930c0855e2ce92e51eb7">00713</a>     <span class="keyword">def </span><a class="code" href="namespacePlurk_1_1oauth2.html#ac1a5d9586a7629f2d9f2004961059799">build_authenticate_header</a>(self, realm=&#39;&#39;):
<a name="l00714"></a>00714         <span class="stringliteral">&quot;&quot;&quot;Optional support for the authenticate header.&quot;&quot;&quot;</span>
<a name="l00715"></a>00715         <span class="keywordflow">return</span> {<span class="stringliteral">&#39;WWW-Authenticate&#39;</span>: <span class="stringliteral">&#39;OAuth realm=&quot;%s&quot;&#39;</span> % realm}
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     <span class="keyword">def </span>_check_version(self, request):
<a name="l00718"></a>00718         <span class="stringliteral">&quot;&quot;&quot;Verify the correct version of the request for this server.&quot;&quot;&quot;</span>
<a name="l00719"></a>00719         version = self.<a class="code" href="classPlurk_1_1oauth2_1_1Server.html#a6c8305fe117013e25a5d472ce7970dba">_get_version</a>(request)
<a name="l00720"></a>00720         <span class="keywordflow">if</span> version <span class="keywordflow">and</span> version != self.<a class="code" href="classPlurk_1_1oauth2_1_1Server.html#a35e678b0af7f61b79450bef80974bb7a">version</a>:
<a name="l00721"></a>00721             <span class="keywordflow">raise</span> Error(<span class="stringliteral">&#39;OAuth version %s not supported.&#39;</span> % str(version))
<a name="l00722"></a>00722 
<a name="l00723"></a>00723     <span class="keyword">def </span>_get_version(self, request):
<a name="l00724"></a>00724         <span class="stringliteral">&quot;&quot;&quot;Return the version of the request for this server.&quot;&quot;&quot;</span>
<a name="l00725"></a>00725         <span class="keywordflow">try</span>:
<a name="l00726"></a>00726             version = request.get_parameter(<span class="stringliteral">&#39;oauth_version&#39;</span>)
<a name="l00727"></a>00727         <span class="keywordflow">except</span>:
<a name="l00728"></a>00728             version = OAUTH_VERSION
<a name="l00729"></a>00729 
<a name="l00730"></a>00730         <span class="keywordflow">return</span> version
<a name="l00731"></a>00731 
<a name="l00732"></a>00732     <span class="keyword">def </span>_get_signature_method(self, request):
<a name="l00733"></a>00733         <span class="stringliteral">&quot;&quot;&quot;Figure out the signature with some defaults.&quot;&quot;&quot;</span>
<a name="l00734"></a>00734         <span class="keywordflow">try</span>:
<a name="l00735"></a>00735             signature_method = request.get_parameter(<span class="stringliteral">&#39;oauth_signature_method&#39;</span>)
<a name="l00736"></a>00736         <span class="keywordflow">except</span>:
<a name="l00737"></a>00737             signature_method = SIGNATURE_METHOD
<a name="l00738"></a>00738 
<a name="l00739"></a>00739         <span class="keywordflow">try</span>:
<a name="l00740"></a>00740             <span class="comment"># Get the signature method object.</span>
<a name="l00741"></a>00741             signature_method = self.<a class="code" href="classPlurk_1_1oauth2_1_1Server.html#ab9bee8597bcbbb173b312d922298019f">signature_methods</a>[signature_method]
<a name="l00742"></a>00742         <span class="keywordflow">except</span>:
<a name="l00743"></a>00743             signature_method_names = <span class="stringliteral">&#39;, &#39;</span>.join(self.<a class="code" href="classPlurk_1_1oauth2_1_1Server.html#ab9bee8597bcbbb173b312d922298019f">signature_methods</a>.keys())
<a name="l00744"></a>00744             <span class="keywordflow">raise</span> Error(<span class="stringliteral">&#39;Signature method %s not supported try one of the following: %s&#39;</span> % (signature_method, signature_method_names))
<a name="l00745"></a>00745 
<a name="l00746"></a>00746         <span class="keywordflow">return</span> signature_method
<a name="l00747"></a>00747 
<a name="l00748"></a>00748     <span class="keyword">def </span>_get_verifier(self, request):
<a name="l00749"></a>00749         <span class="keywordflow">return</span> request.get_parameter(<span class="stringliteral">&#39;oauth_verifier&#39;</span>)
<a name="l00750"></a>00750 
<a name="l00751"></a>00751     <span class="keyword">def </span>_check_signature(self, request, consumer, token):
<a name="l00752"></a>00752         timestamp, nonce = request._get_timestamp_nonce()
<a name="l00753"></a>00753         self.<a class="code" href="classPlurk_1_1oauth2_1_1Server.html#a43136389193c2dd85f07975e3327520d">_check_timestamp</a>(timestamp)
<a name="l00754"></a>00754         signature_method = self.<a class="code" href="classPlurk_1_1oauth2_1_1Server.html#a1b62bb9a3153ad224497dfe5475dee0e">_get_signature_method</a>(request)
<a name="l00755"></a>00755 
<a name="l00756"></a>00756         <span class="keywordflow">try</span>:
<a name="l00757"></a>00757             signature = request.get_parameter(<span class="stringliteral">&#39;oauth_signature&#39;</span>)
<a name="l00758"></a>00758         <span class="keywordflow">except</span>:
<a name="l00759"></a>00759             <span class="keywordflow">raise</span> MissingSignature(<span class="stringliteral">&#39;Missing oauth_signature.&#39;</span>)
<a name="l00760"></a>00760 
<a name="l00761"></a>00761         <span class="comment"># Validate the signature.</span>
<a name="l00762"></a>00762         valid = signature_method.check(request, consumer, token, signature)
<a name="l00763"></a>00763 
<a name="l00764"></a>00764         <span class="keywordflow">if</span> <span class="keywordflow">not</span> valid:
<a name="l00765"></a>00765             key, base = signature_method.signing_base(request, consumer, token)
<a name="l00766"></a>00766 
<a name="l00767"></a>00767             <span class="keywordflow">raise</span> Error(<span class="stringliteral">&#39;Invalid signature. Expected signature base &#39;</span> 
<a name="l00768"></a>00768                 <span class="stringliteral">&#39;string: %s&#39;</span> % base)
<a name="l00769"></a>00769 
<a name="l00770"></a>00770     <span class="keyword">def </span>_check_timestamp(self, timestamp):
<a name="l00771"></a>00771         <span class="stringliteral">&quot;&quot;&quot;Verify that timestamp is recentish.&quot;&quot;&quot;</span>
<a name="l00772"></a>00772         timestamp = int(timestamp)
<a name="l00773"></a>00773         now = int(time.time())
<a name="l00774"></a>00774         lapsed = now - timestamp
<a name="l00775"></a>00775         <span class="keywordflow">if</span> lapsed &gt; self.<a class="code" href="classPlurk_1_1oauth2_1_1Server.html#afae113e4f6527b21a0e70c4486dc154f">timestamp_threshold</a>:
<a name="l00776"></a>00776             <span class="keywordflow">raise</span> Error(<span class="stringliteral">&#39;Expired timestamp: given %d and now %s has a &#39;</span>
<a name="l00777"></a>00777                 <span class="stringliteral">&#39;greater difference than threshold %d&#39;</span> % (timestamp, now, 
<a name="l00778"></a>00778                     self.<a class="code" href="classPlurk_1_1oauth2_1_1Server.html#afae113e4f6527b21a0e70c4486dc154f">timestamp_threshold</a>))
<a name="l00779"></a>00779 
<a name="l00780"></a>00780 
<a name="l00781"></a><a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod.html">00781</a> <span class="keyword">class </span><a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod.html">SignatureMethod</a>(object):
<a name="l00782"></a>00782     <span class="stringliteral">&quot;&quot;&quot;A way of signing requests.</span>
<a name="l00783"></a>00783 <span class="stringliteral"> </span>
<a name="l00784"></a>00784 <span class="stringliteral">    The OAuth protocol lets consumers and service providers pick a way to sign</span>
<a name="l00785"></a>00785 <span class="stringliteral">    requests. This interface shows the methods expected by the other `oauth`</span>
<a name="l00786"></a>00786 <span class="stringliteral">    modules for signing requests. Subclass it and implement its methods to</span>
<a name="l00787"></a>00787 <span class="stringliteral">    provide a new way to sign requests.</span>
<a name="l00788"></a>00788 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00789"></a>00789 
<a name="l00790"></a><a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod.html#ae178f64320c09cc5d5b05d00e7585901">00790</a>     <span class="keyword">def </span>signing_base(self, request, consumer, token):
<a name="l00791"></a>00791         <span class="stringliteral">&quot;&quot;&quot;Calculates the string that needs to be signed.</span>
<a name="l00792"></a>00792 <span class="stringliteral"></span>
<a name="l00793"></a>00793 <span class="stringliteral">        This method returns a 2-tuple containing the starting key for the</span>
<a name="l00794"></a>00794 <span class="stringliteral">        signing and the message to be signed. The latter may be used in error</span>
<a name="l00795"></a>00795 <span class="stringliteral">        messages to help clients debug their software.</span>
<a name="l00796"></a>00796 <span class="stringliteral"></span>
<a name="l00797"></a>00797 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00798"></a>00798         <span class="keywordflow">raise</span> NotImplementedError
<a name="l00799"></a>00799 
<a name="l00800"></a><a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod.html#a593a5e56536d8098f5d0ad1a1e225e3e">00800</a>     <span class="keyword">def </span>sign(self, request, consumer, token):
<a name="l00801"></a>00801         <span class="stringliteral">&quot;&quot;&quot;Returns the signature for the given request, based on the consumer</span>
<a name="l00802"></a>00802 <span class="stringliteral">        and token also provided.</span>
<a name="l00803"></a>00803 <span class="stringliteral"></span>
<a name="l00804"></a>00804 <span class="stringliteral">        You should use your implementation of `signing_base()` to build the</span>
<a name="l00805"></a>00805 <span class="stringliteral">        message to sign. Otherwise it may be less useful for debugging.</span>
<a name="l00806"></a>00806 <span class="stringliteral"></span>
<a name="l00807"></a>00807 <span class="stringliteral">        &quot;&quot;&quot;</span>
<a name="l00808"></a>00808         <span class="keywordflow">raise</span> NotImplementedError
<a name="l00809"></a>00809 
<a name="l00810"></a><a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod.html#a967bb393e9f76bdb4028401d3a4cc9a9">00810</a>     <span class="keyword">def </span>check(self, request, consumer, token, signature):
<a name="l00811"></a>00811         <span class="stringliteral">&quot;&quot;&quot;Returns whether the given signature is the correct signature for</span>
<a name="l00812"></a>00812 <span class="stringliteral">        the given consumer and token signing the given request.&quot;&quot;&quot;</span>
<a name="l00813"></a>00813         built = self.<a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod.html#a593a5e56536d8098f5d0ad1a1e225e3e">sign</a>(request, consumer, token)
<a name="l00814"></a>00814         <span class="keywordflow">return</span> built == signature
<a name="l00815"></a>00815 
<a name="l00816"></a>00816 
<a name="l00817"></a><a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod__HMAC__SHA1.html">00817</a> <span class="keyword">class </span><a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod__HMAC__SHA1.html">SignatureMethod_HMAC_SHA1</a>(<a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod.html">SignatureMethod</a>):
<a name="l00818"></a>00818     name = <span class="stringliteral">&#39;HMAC-SHA1&#39;</span>
<a name="l00819"></a>00819 
<a name="l00820"></a><a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod__HMAC__SHA1.html#a3b6c531322d51c31ce12710f6e316323">00820</a>     <span class="keyword">def </span>signing_base(self, request, consumer, token):
<a name="l00821"></a>00821         <span class="keywordflow">if</span> <span class="keywordflow">not</span> hasattr(request, <span class="stringliteral">&#39;normalized_url&#39;</span>) <span class="keywordflow">or</span> request.normalized_url <span class="keywordflow">is</span> <span class="keywordtype">None</span>:
<a name="l00822"></a>00822             <span class="keywordflow">raise</span> ValueError(<span class="stringliteral">&quot;Base URL for request is not set.&quot;</span>)
<a name="l00823"></a>00823 
<a name="l00824"></a>00824         sig = (
<a name="l00825"></a>00825             escape(request.method),
<a name="l00826"></a>00826             escape(request.normalized_url),
<a name="l00827"></a>00827             escape(request.get_normalized_parameters()),
<a name="l00828"></a>00828         )
<a name="l00829"></a>00829 
<a name="l00830"></a>00830         key = <span class="stringliteral">&#39;%s&amp;&#39;</span> % escape(consumer.secret)
<a name="l00831"></a>00831         <span class="keywordflow">if</span> token:
<a name="l00832"></a>00832             key += escape(token.secret)
<a name="l00833"></a>00833         raw = <span class="stringliteral">&#39;&amp;&#39;</span>.join(sig)
<a name="l00834"></a>00834         <span class="keywordflow">return</span> key, raw
<a name="l00835"></a>00835 
<a name="l00836"></a><a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod__HMAC__SHA1.html#a4aa879b79ffcdfea5c52d3b4c9b22e52">00836</a>     <span class="keyword">def </span>sign(self, request, consumer, token):
<a name="l00837"></a>00837         <span class="stringliteral">&quot;&quot;&quot;Builds the base signature string.&quot;&quot;&quot;</span>
<a name="l00838"></a>00838         key, raw = self.<a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod__HMAC__SHA1.html#a3b6c531322d51c31ce12710f6e316323">signing_base</a>(request, consumer, token)
<a name="l00839"></a>00839 
<a name="l00840"></a>00840         hashed = hmac.new(key, raw, sha)
<a name="l00841"></a>00841 
<a name="l00842"></a>00842         <span class="comment"># Calculate the digest base 64.</span>
<a name="l00843"></a>00843         <span class="keywordflow">return</span> binascii.b2a_base64(hashed.digest())[:-1]
<a name="l00844"></a>00844 
<a name="l00845"></a>00845 
<a name="l00846"></a><a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod__PLAINTEXT.html">00846</a> <span class="keyword">class </span><a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod__PLAINTEXT.html">SignatureMethod_PLAINTEXT</a>(<a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod.html">SignatureMethod</a>):
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     name = <span class="stringliteral">&#39;PLAINTEXT&#39;</span>
<a name="l00849"></a>00849 
<a name="l00850"></a><a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod__PLAINTEXT.html#a65696558f6912d1880a46da40c697625">00850</a>     <span class="keyword">def </span>signing_base(self, request, consumer, token):
<a name="l00851"></a>00851         <span class="stringliteral">&quot;&quot;&quot;Concatenates the consumer key and secret with the token&#39;s</span>
<a name="l00852"></a>00852 <span class="stringliteral">        secret.&quot;&quot;&quot;</span>
<a name="l00853"></a>00853         sig = <span class="stringliteral">&#39;%s&amp;&#39;</span> % escape(consumer.secret)
<a name="l00854"></a>00854         <span class="keywordflow">if</span> token:
<a name="l00855"></a>00855             sig = sig + escape(token.secret)
<a name="l00856"></a>00856         <span class="keywordflow">return</span> sig, sig
<a name="l00857"></a>00857 
<a name="l00858"></a><a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod__PLAINTEXT.html#aeeb2133ed21959ece5aa5f608314b7c5">00858</a>     <span class="keyword">def </span>sign(self, request, consumer, token):
<a name="l00859"></a>00859         key, raw = self.<a class="code" href="classPlurk_1_1oauth2_1_1SignatureMethod__PLAINTEXT.html#a65696558f6912d1880a46da40c697625">signing_base</a>(request, consumer, token)
<a name="l00860"></a>00860         <span class="keywordflow">return</span> raw
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Sun Jun 24 2012 20:50:11 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
